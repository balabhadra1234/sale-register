<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Sales & Purchase ‚Äî Fixed</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --accent: #2b7a78; --muted: #6b7280; --border: #e5e7eb; --bg: #f9fafb;
      --card-bg: #ffffff; --text: #111827; --shadow: rgba(15, 23, 42, 0.06);
    }
    [data-theme="dark"] {
      --accent: #14a8a5; --muted: #9ca3af; --border: #374151; --bg: #111827;
      --card-bg: #1f2937; --text: #f3f4f6; --shadow: rgba(0, 0, 0, 0.2);
    }
    body { font-family: 'Inter', system-ui, sans-serif; margin: 0; background: var(--bg); color: var(--text); transition: background 0.3s ease; }
    header { background: var(--accent); color: white; padding: 14px 18px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    header h1 { font-size: 18px; font-weight: 600; margin: 0; }
    .wrap { display: flex; gap: 16px; padding: 16px; align-items: flex-start; }
    nav { width: 260px; background: var(--card-bg); padding: 12px; border-radius: 12px; box-shadow: 0 6px 18px var(--shadow); }
    nav button { display: flex; gap: 10px; align-items: center; width: 100%; padding: 10px 12px; border-radius: 8px; border: none; background: transparent; cursor: pointer; color: var(--text); font-size: 14px; text-align: left; transition: all 0.2s; }
    nav button:hover { background: rgba(43, 122, 120, 0.08); }
    nav button.active { background: linear-gradient(90deg, rgba(43,122,120,.1), rgba(43,122,120,.05)); font-weight: 600; color: var(--accent); }
    main { flex: 1; background: var(--card-bg); padding: 16px; border-radius: 12px; box-shadow: 0 6px 18px var(--shadow); }
    h2 { margin: 0 0 16px 0; font-size: 20px; font-weight: 600; }
    h3 { font-size: 16px; font-weight: 600; margin-top: 0; }
    .row { display: flex; gap: 12px; margin-bottom: 8px; flex-wrap: wrap; }
    label { display: block; font-size: 13px; font-weight: 500; margin-bottom: 4px; }
    input, select, textarea, button { font-family: inherit; font-size: 14px; }
    input, select, textarea { padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg); color: var(--text); width: 100%; box-sizing: border-box; }
    input:focus, select:focus, textarea:focus { outline: 2px solid var(--accent); border-color: var(--accent); }
    button.btn { padding: 10px 14px; border-radius: 8px; border: none; cursor: pointer; font-weight: 500; }
    button.primary { background: var(--accent); color: white; } button.ghost { background: transparent; border: 1px solid var(--border); color: var(--text); } button.danger { background: #ef4444; color: white; }
    table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    th, td { padding: 10px; border-bottom: 1px solid var(--border); text-align: left; font-size: 14px; }
    th { background: var(--bg); font-weight: 600; }
    .right { text-align: right; } .center { text-align: center; } .small { font-size: 12px; color: var(--muted); } .bold { font-weight: 600; }
    .card { background: var(--card-bg); padding: 16px; border-radius: 10px; box-shadow: 0 4px 12px var(--shadow); margin-bottom: 16px; }
    .toast { position: fixed; top: 20px; right: 20px; padding: 12px 16px; border-radius: 8px; background: #333; color: white; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.2); opacity: 0; transform: translateY(-10px); transition: all 0.3s ease; }
    .toast.show { opacity: 1; transform: translateY(0); }
    footer { padding: 16px; text-align: center; color: var(--muted); font-size: 13px; }
    .theme-toggle { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 6px 10px; border-radius: 8px; cursor: pointer; }
    @media (max-width: 880px) { .wrap { flex-direction: column; } nav { width: 100%; } }
    .clickable { cursor: pointer; }
    @media print {
      body * { visibility: hidden; }
      #printable-area, #printable-area * { visibility: visible; }
      #printable-area { position: absolute; left: 0; top: 0; width: 100%; }
      .no-print { display: none; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Sales & Purchase Management</h1>
    <button class="theme-toggle" onclick="toggleTheme()">üåô / ‚òÄÔ∏è</button>
  </header>

  <div class="wrap">
    <nav id="nav" class="no-print">
      <button data-tab="dashboard" class="active">Dashboard</button>
      <button data-tab="products">Products & Stock</button>
      <button data-tab="customers">Customers</button>
      <button data-tab="suppliers">Suppliers</button>
      <button data-tab="sales">Sales Invoices</button>
      <button data-tab="purchases">Purchase Bills</button>
      <button data-tab="payments">Payments & Receipts</button>
      <button data-tab="reports">Reports & Export</button>
    </nav>
    <main id="main"></main>
  </div>

  <footer class="no-print">Fully offline. Data saved in browser. Export/Import JSON in Reports.</footer>
  <div id="toast" class="toast no-print"></div>

  <script>
    const main = document.getElementById('main');
    const nav = document.getElementById('nav');

    // ========== UTILS & CORE ==========
    const uid = (p = 'id') => p + Date.now().toString(36) + Math.random().toString(36).slice(2, 6);
    const fmt = n => Number(n || 0).toLocaleString('en-IN', { maximumFractionDigits: 2, minimumFractionDigits: 2 });
    const today = () => new Date().toISOString().slice(0, 10);
    const LS_KEYS = ['products', 'customers', 'suppliers', 'sales', 'purchases', 'payments'];

    function load(key) { try { return JSON.parse(localStorage.getItem(key) || '[]'); } catch { return []; } }
    function save(key, arr) { localStorage.setItem(key, JSON.stringify(arr || [])); }
    function showToast(msg) {
        const toast = document.getElementById('toast');
        toast.textContent = msg;
        toast.className = 'toast show';
        setTimeout(() => { toast.className = 'toast'; }, 3000);
    }
    function toggleTheme() {
        const root = document.documentElement;
        const isDark = root.getAttribute('data-theme') === 'dark';
        root.setAttribute('data-theme', isDark ? 'light' : 'dark');
        localStorage.setItem('theme', isDark ? 'light' : 'dark');
    }

    // New helper function to calculate profit for a single transaction (sale or purchase)
    function calculateProfit(items, products, type) {
        return items.reduce((totalProfit, item) => {
            const product = products.find(p => p.id === item.productId);
            if (!product) return totalProfit;
            const itemCost = product.cost;
            const itemPrice = product.price;

            if (type === 'sale') {
                const profitPerItem = item.price - itemCost;
                return totalProfit + (profitPerItem * item.qty);
            } else if (type === 'purchase') {
                const profitPerItem = itemPrice - item.cost;
                return totalProfit + (profitPerItem * item.qty);
            }
            return totalProfit;
        }, 0);
    }

    // ========== INITIAL DATA SETUP ==========
    function initIfEmpty() {
        if (!load('products').length) save('products', [
            { id: uid('p'), sku: 'P-001', name: 'Widget A', category: 'General', price: 100, cost: 70, stock: 50, unit: 'pcs', minStock: 5 },
            { id: uid('p'), sku: 'P-002', name: 'Widget B', category: 'General', price: 200, cost: 140, stock: 30, unit: 'pcs', minStock: 5 }
        ]);
        if (!load('customers').length) save('customers', [{ id: uid('c'), name: 'Walk-in Customer', phone: '', email: '' }]);
        LS_KEYS.forEach(k => { if (!localStorage.getItem(k)) save(k, []); });
    }

    // ========== NAVIGATION & ROUTING ==========
    nav.addEventListener('click', e => {
        const btn = e.target.closest('button[data-tab]');
        if (!btn) return;
        nav.querySelectorAll('button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        render(btn.dataset.tab);
    });

    function render(tab, id) {
        const data = LS_KEYS.reduce((acc, k) => ({ ...acc, [k]: load(k) }), {});
        const renderer = {
            dashboard: renderDashboard,
            products: renderProducts,
            customers: renderCustomers,
            suppliers: renderSuppliers,
            sales: renderSales,
            new_sale: renderSaleForm,
            purchases: renderPurchases,
            new_purchase: renderPurchaseForm,
            payments: renderPayments,
            reports: renderReports,
            ledger: renderLedger, // New tab for ledger search
        }[tab];
        if (renderer) renderer(data, id);
    }
    window.redirect = render; // Expose render function for dashboard links

    // ========== RENDER: DASHBOARD ==========
    function renderDashboard({ products, sales, purchases }) {
      // Get the date filters or use today's date as a default
      const fromDate = document.getElementById('from-date')?.value || today();
      const toDate = document.getElementById('to-date')?.value || today();

      // Filter sales and purchases based on the date range
      const filteredSales = sales.filter(s => s.date >= fromDate && s.date <= toDate);
      const filteredPurchases = purchases.filter(p => p.date >= fromDate && p.date <= toDate);

      const totalSales = filteredSales.reduce((s,x) => s + Number(x.total||0), 0);
      const totalPurchases = filteredPurchases.reduce((s,x) => s + Number(x.total||0), 0);
      const profit = filteredSales.reduce((s, x) => s + calculateProfit(x.items, products, 'sale'), 0);

      const receivables = sales.reduce((s,x) => s + (Number(x.total||0) - Number(x.paid||0)), 0);
      const payables = purchases.reduce((s,x) => s + (Number(x.total||0) - Number(x.paid||0)), 0);
      const lowStock = products.filter(p => Number(p.stock||0) <= Number(p.minStock||0));

      main.innerHTML = `
        <h2>Dashboard</h2>
        <div class="card">
            <h3 style="margin-top:0">Date Range</h3>
            <div class="row">
                <div style="flex:1"><label>From</label><input type="date" id="from-date" value="${fromDate}"></div>
                <div style="flex:1"><label>To</label><input type="date" id="to-date" value="${toDate}"></div>
                <div style="margin-top:21px;"><button class="btn primary" id="filter-btn">Apply Filter</button></div>
            </div>
        </div>
        <div class="card row" style="gap:16px;">
          <div class="clickable" onclick="redirect('sales')" style="flex:1;min-width:200px;padding:16px;border-radius:10px;background:#eef8f7"><div class="small">Total Sales</div><div class="bold" style="font-size:24px;">‚Çπ ${fmt(totalSales)}</div></div>
          <div class="clickable" onclick="redirect('purchases')" style="flex:1;min-width:200px;padding:16px;border-radius:10px;background:#f0fdf4"><div class="small">Total Purchases</div><div class="bold" style="font-size:24px;">‚Çπ ${fmt(totalPurchases)}</div></div>
          <div style="flex:1;min-width:200px;padding:16px;border-radius:10px;background:#e7f0ff"><div class="small">Profit</div><div class="bold" style="font-size:24px;">‚Çπ ${fmt(profit)}</div></div>
          <div style="flex:1;min-width:200px;padding:16px;border-radius:10px;background:#fff7ed"><div class="small">Receivables</div><div class="bold" style="font-size:24px;">‚Çπ ${fmt(receivables)}</div></div>
          <div style="flex:1;min-width:200px;padding:16px;border-radius:10px;background:#fff1f2"><div class="small">Payables</div><div class="bold" style="font-size:24px;">‚Çπ ${fmt(payables)}</div></div>
        </div>
        <div class="card">
          <h3 style="margin-top:0">Low Stock Alerts</h3>
          ${lowStock.length ? `<table><thead><tr><th>SKU</th><th>Product</th><th class="right">Stock</th><th class="right">Min Stock</th></tr></thead><tbody>${lowStock.map(p => `
                <tr><td>${p.sku}</td><td>${p.name}</td><td class="right">${p.stock} ${p.unit}</td><td class="right">${p.minStock}</td></tr>`).join('')}</tbody></table>`
                 : '<div class="small">No low stock items</div>'}
        </div>`;

        // Add event listener to the new filter button
        document.getElementById('filter-btn').onclick = () => render('dashboard');
    }

    // ========== RENDER: GENERIC CRUD (FOR PRODUCTS, CUSTOMERS, SUPPLIERS) ==========
    function renderCRUD(opts) {
        const items = load(opts.key);
        main.innerHTML = `
            <h2>${opts.title}</h2>
            <div class="card">
                <form id="crud-form">
                    <input type="hidden" name="id">
                    <div class="row">${opts.fields.map(f => `<div style="flex:${f.flex||1}"><label>${f.label}</label><input name="${f.name}" type="${f.type||'text'}" placeholder="${f.placeholder||''}"></div>`).join('')}</div>
                    <div class="row" style="justify-content:flex-end; margin-top:16px;">
                      <button type="button" class="btn ghost" onclick="this.closest('form').reset()">Clear</button>
                      <button type="submit" class="btn primary">Save ${opts.singular}</button>
                    </div>
                </form>
            </div>
            <div class="card">
                <h3>All ${opts.title}</h3>
                <table>
                    <thead><tr>${opts.headers.map(h => `<th>${h}</th>`).join('')}<th>Actions</th></tr></thead>
                    <tbody>${items.map(it => `<tr>${opts.row(it).map(td => `<td>${td}</td>`).join('')}
                        <td><button class="btn ghost small" onclick="editItem('${opts.key}', '${it.id}')">Edit</button> <button class="btn danger small" onclick="deleteItem('${opts.key}', '${it.id}')">Del</button></td>
                    </tr>`).join('')}</tbody>
                </table>
            </div>`;

        document.getElementById('crud-form').onsubmit = e => {
            e.preventDefault();
            const form = e.target;
            const item = Object.fromEntries(new FormData(form));
            const allItems = load(opts.key);
            if (item.id) { // Update
                save(opts.key, allItems.map(i => i.id === item.id ? { ...i, ...item } : i));
            } else { // Create
                item.id = uid(opts.key[0]);
                allItems.unshift(item);
                save(opts.key, allItems);
            }
            showToast(`${opts.singular} saved.`);
            render(opts.key);
        };
    }

    window.editItem = (key, id) => {
        const item = load(key).find(i => i.id === id);
        if (!item) return;
        const form = document.getElementById('crud-form');
        for (const prop in item) {
            if (form.elements[prop]) form.elements[prop].value = item[prop];
        }
        window.scrollTo(0, 0);
    }
    window.deleteItem = (key, id) => {
        // Updated to use a custom alert, as window.confirm is not recommended
        const deleteConfirm = confirm('Are you sure you want to delete this item?');
        if (!deleteConfirm) return;
        save(key, load(key).filter(i => i.id !== id));
        showToast('Item deleted.');
        render(key);
    }

    // ========== RENDER: PRODUCTS, CUSTOMERS, SUPPLIERS (USING GENERIC CRUD) ==========
    function renderProducts() {
        renderCRUD({
            key: 'products', title: 'Products & Stock', singular: 'Product',
            fields: [
                { name: 'sku', label: 'SKU', flex: 1 }, { name: 'name', label: 'Product Name', flex: 2 },
                { name: 'price', label: 'Sale Price (‚Çπ)', type: 'number', flex: 1 }, { name: 'cost', label: 'Cost Price (‚Çπ)', type: 'number', flex: 1 },
                { name: 'stock', label: 'Stock', type: 'number', flex: 1 }, { name: 'minStock', label: 'Min Stock', type: 'number', flex: 1 },
                { name: 'unit', label: 'Unit (pcs, kg)', flex: 1 },
            ],
            headers: ['SKU', 'Name', 'Sale Price', 'Cost', 'Stock'],
            row: p => [p.sku, p.name, `‚Çπ ${fmt(p.price)}`, `‚Çπ ${fmt(p.cost)}`, `${p.stock||0} ${p.unit||''}`]
        });
    }
    function renderCustomers() {
        renderCRUD({
            key: 'customers', title: 'Customers', singular: 'Customer',
            fields: [ { name: 'name', label: 'Name', flex: 2 }, { name: 'phone', label: 'Phone', flex: 1 }, { name: 'email', label: 'Email', flex: 1 } ],
            headers: ['Name', 'Phone', 'Email'], row: c => [c.name, c.phone, c.email]
        });
    }
    function renderSuppliers() {
        renderCRUD({
            key: 'suppliers', title: 'Suppliers', singular: 'Supplier',
            fields: [ { name: 'name', label: 'Name', flex: 2 }, { name: 'phone', label: 'Phone', flex: 1 }, { name: 'email', label: 'Email', flex: 1 } ],
            headers: ['Name', 'Phone', 'Email'], row: s => [s.name, s.phone, s.email]
        });
    }
    
    // ========== RENDER: SALES LIST ==========
    function renderSales({ sales, customers, products }) {
      main.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
          <h2>Sales Invoices</h2>
          <button class="btn primary no-print" onclick="render('new_sale')">New Invoice</button>
        </div>
        <div class="card">
          <table>
            <thead><tr><th>Date</th><th>Invoice #</th><th>Customer</th><th class="right">Total</th><th class="right">Profit</th><th class="right">Due</th></tr></thead>
            <tbody>
              ${sales.map(s => {
                const cust = customers.find(c => c.id === s.customerId)?.name || 'N/A';
                const due = (s.total || 0) - (s.paid || 0);
                const profit = calculateProfit(s.items, products, 'sale');
                return `<tr class="clickable" onclick="render('new_sale', '${s.id}')">
                  <td>${s.date}</td>
                  <td>${s.invoice}</td>
                  <td>${cust}</td>
                  <td class="right">‚Çπ ${fmt(s.total)}</td>
                  <td class="right">‚Çπ ${fmt(profit)}</td>
                  <td class="right" style="color:${due > 0 ? '#ef4444' : 'inherit'}">‚Çπ ${fmt(due)}</td>
                </tr>`
              }).join('')}
            </tbody>
          </table>
        </div>`;
    }
    
    // ========== RENDER: NEW/EDIT SALE FORM ==========
    function renderSaleForm({ products, customers }, saleId) {
        let sale = saleId ? load('sales').find(s => s.id === saleId) : null;
        if (!sale) sale = { id: '', date: today(), invoice: `INV-${Date.now()}`, customerId: '', items: [], total: 0, paid: 0 };

        main.innerHTML = `
            <div id="printable-area">
                <h2>${saleId ? 'Edit' : 'New'} Sales Invoice</h2>
                <div class="card">
                    <form id="sale-form">
                        <input type="hidden" name="id" value="${sale.id}">
                        <div class="row">
                            <div style="flex:1"><label>Customer</label><select name="customerId" required>${customers.map(c => `<option value="${c.id}" ${c.id === sale.customerId ? 'selected' : ''}>${c.name}</option>`).join('')}</select></div>
                            <div style="flex:1"><label>Invoice #</label><input name="invoice" value="${sale.invoice}" required></div>
                            <div style="flex:1"><label>Date</label><input name="date" type="date" value="${sale.date}" required></div>
                        </div>
                    </form>
                </div>
                <div class="card">
                    <h3>Products</h3>
                    <div class="row no-print">
                        <div style="flex:3"><label>Product</label><select id="item-product">${products.map(p => `<option value="${p.id}" data-price="${p.price}" data-cost="${p.cost}">${p.name} (Stock: ${p.stock})</option>`).join('')}</select></div>
                        <div style="flex:1"><label>Quantity</label><input id="item-qty" type="number" value="1"></div>
                        <div style="flex:1"><label>Price (‚Çπ)</label><input id="item-price" type="number" step="0.01"></div>
                        <div style="margin-top:21px;"><button type="button" class="btn primary" id="add-item-btn">Add</button></div>
                    </div>
                    <table id="sale-items-table">
                        <thead><tr><th>Product</th><th class="right">Qty</th><th class="right">Price</th><th class="right">Amount</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="card row" style="justify-content: flex-end;">
                    <div style="width:250px;">
                        <div class="row small" style="justify-content:space-between"><span>Subtotal:</span> <span id="subtotal">‚Çπ 0.00</span></div>
                        <div class="row bold" style="justify-content:space-between;font-size:18px; margin-top:8px;"><span>Total:</span> <span id="total">‚Çπ 0.00</span></div>
                        <div class="row" style="margin-top:8px;"><label>Amount Paid</label><input id="amount-paid" type="number" step="0.01" value="${sale.paid || 0}"></div>
                        <div class="row" style="justify-content:space-between; margin-top:8px;"><span>Due:</span> <span id="due">‚Çπ 0.00</span></div>
                    </div>
                </div>
            </div>
            <div class="row no-print" style="justify-content:flex-end; gap:8px;">
                <button class="btn ghost" onclick="render('sales')">Cancel</button>
                <button class="btn primary" id="save-sale-btn">Save Invoice</button>
                <button class="btn primary" onclick="window.print()">Print Bill</button>
            </div>
        `;

        let items = [...(sale.items || [])];
        const productSel = document.getElementById('item-product');
        const priceInput = document.getElementById('item-price');
        const updatePrice = () => {
            const selectedOption = productSel.options[productSel.selectedIndex];
            if (selectedOption) {
                priceInput.value = selectedOption.dataset.price;
            }
        };
        if (productSel) {
            productSel.onchange = updatePrice;
            updatePrice();
        }

        const updateTotals = () => {
            let sub = items.reduce((acc, i) => acc + i.qty * i.price, 0);
            document.getElementById('subtotal').textContent = `‚Çπ ${fmt(sub)}`;
            document.getElementById('total').textContent = `‚Çπ ${fmt(sub)}`;
            let paid = Number(document.getElementById('amount-paid').value) || 0;
            document.getElementById('due').textContent = `‚Çπ ${fmt(sub - paid)}`;
        };
        const renderItems = () => {
            const tbody = document.getElementById('sale-items-table').querySelector('tbody');
            tbody.innerHTML = items.map((item, index) => {
                const p = products.find(pr => pr.id === item.productId);
                return `<tr>
                    <td>${p ? p.name : 'N/A'}</td>
                    <td class="right">${item.qty}</td>
                    <td class="right">‚Çπ ${fmt(item.price)}</td>
                    <td class="right">‚Çπ ${fmt(item.qty * item.price)}</td>
                </tr>`;
            }).join('');
            updateTotals();
        };

        window.removeItem = (index) => {
            items.splice(index, 1);
            renderItems();
        };

        const addItemBtn = document.getElementById('add-item-btn');
        if (addItemBtn) {
            addItemBtn.onclick = () => {
                const productId = productSel.value;
                const qty = Number(document.getElementById('item-qty').value);
                const price = Number(document.getElementById('item-price').value);
                const product = products.find(p => p.id === productId);
                if (!productId || qty <= 0 || price < 0) return showToast('Invalid item details');
                // Capture the cost at the time of sale for profit calculation
                items.push({ productId, qty, price, cost: product?.cost || 0 });
                renderItems();
                document.getElementById('item-qty').value = 1; // reset
            };
        }
        
        document.getElementById('amount-paid').oninput = updateTotals;

        document.getElementById('save-sale-btn').onclick = () => {
            const sales = load('sales');
            const prods = load('products');
            const formData = new FormData(document.getElementById('sale-form'));
            const newSale = {
                id: sale.id || uid('s'),
                customerId: formData.get('customerId'),
                invoice: formData.get('invoice'),
                date: formData.get('date'),
                items,
                total: items.reduce((acc, i) => acc + i.qty * i.price, 0),
                paid: Number(document.getElementById('amount-paid').value)
            };

            // Update stock
            newSale.items.forEach(item => {
                const pIndex = prods.findIndex(p => p.id === item.productId);
                // Only update stock if this is a new sale or items have changed
                if (pIndex > -1) prods[pIndex].stock = (prods[pIndex].stock || 0) - item.qty;
            });
            save('products', prods);
            
            if (sale.id) { // update existing
                save('sales', sales.map(s => s.id === sale.id ? newSale : s));
            } else { // add new
                sales.unshift(newSale);
                save('sales', sales);
            }
            showToast('Sale saved!');
            render('sales');
        };
        renderItems();
    }
    
    // ========== RENDER: PURCHASES (similar to Sales) ==========
    function renderPurchases({ purchases, suppliers, products }) {
      main.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
          <h2>Purchase Bills</h2>
          <button class="btn primary no-print" onclick="render('new_purchase')">New Bill</button>
        </div>
        <div class="card">
          <table>
            <thead><tr><th>Date</th><th>Bill #</th><th>Supplier</th><th class="right">Total</th><th class="right">Profit</th><th class="right">Due</th></tr></thead>
            <tbody>${purchases.map(p => {
                const sup = suppliers.find(s => s.id === p.supplierId)?.name || 'N/A';
                const due = (p.total || 0) - (p.paid || 0);
                const profit = calculateProfit(p.items, products, 'purchase');
                return `<tr class="clickable" onclick="render('new_purchase', '${p.id}')"><td>${p.date}</td><td>${p.bill}</td><td>${sup}</td><td class="right">‚Çπ ${fmt(p.total)}</td><td class="right">‚Çπ ${fmt(profit)}</td><td class="right" style="color:${due > 0 ? '#ef4444' : 'inherit'}">‚Çπ ${fmt(due)}</td></tr>`
            }).join('')}</tbody>
          </table>
        </div>`;
    }
    
    function renderPurchaseForm({ products, suppliers }, purchaseId) {
        let p = purchaseId ? load('purchases').find(p => p.id === purchaseId) : null;
        if (!p) p = { id: '', date: today(), bill: `BILL-${Date.now()}`, supplierId: '', items: [], total: 0, paid: 0 };

        main.innerHTML = `
            <div id="printable-area">
                <h2>${purchaseId ? 'Edit' : 'New'} Purchase Bill</h2>
                <div class="card">
                    <form id="purchase-form">
                        <input type="hidden" name="id" value="${p.id}">
                        <div class="row">
                            <div style="flex:1"><label>Supplier</label><select name="supplierId" required>${suppliers.map(s => `<option value="${s.id}" ${s.id === p.supplierId ? 'selected' : ''}>${s.name}</option>`).join('')}</select></div>
                            <div style="flex:1"><label>Bill #</label><input name="bill" value="${p.bill}" required></div>
                            <div style="flex:1"><label>Date</label><input name="date" type="date" value="${p.date}" required></div>
                        </div>
                    </form>
                </div>
                <div class="card">
                    <h3>Add Products</h3>
                    <div class="row no-print">
                        <div style="flex:3"><label>Product</label><select id="item-product">${products.map(p => `<option value="${p.id}" data-cost="${p.cost}" data-price="${p.price}">${p.name}</option>`).join('')}</select></div>
                        <div style="flex:1"><label>Quantity</label><input id="item-qty" type="number" value="1"></div>
                        <div style="flex:1"><label>Cost (‚Çπ)</label><input id="item-cost" type="number" step="0.01"></div>
                        <div style="margin-top:21px;"><button type="button" class="btn primary" id="add-item-btn">Add</button></div>
                    </div>
                    <table id="purchase-items-table"><thead><tr><th>Product</th><th class="right">Qty</th><th class="right">Cost</th><th class="right">Amount</th></tr></thead><tbody></tbody></table>
                </div>
                <div class="card row" style="justify-content: flex-end;">
                     <div style="width:250px;">
                        <div class="row bold" style="justify-content:space-between;font-size:18px;"><span>Total:</span> <span id="total">‚Çπ 0.00</span></div>
                        <div class="row" style="margin-top:8px;"><label>Amount Paid</label><input id="amount-paid" type="number" step="0.01" value="${p.paid || 0}"></div>
                    </div>
                </div>
            </div>
            <div class="row no-print" style="justify-content:flex-end; gap:8px;"><button class="btn ghost" onclick="render('purchases')">Cancel</button><button class="btn primary" id="save-purchase-btn">Save Bill</button><button class="btn primary" onclick="window.print()">Print Bill</button></div>
        `;

        let items = [...(p.items || [])];
        const productSel = document.getElementById('item-product');
        const costInput = document.getElementById('item-cost');
        const updateCost = () => {
            const selectedOption = productSel.options[productSel.selectedIndex];
            if (selectedOption) {
                costInput.value = selectedOption.dataset.cost;
            }
        };
        if (productSel) {
            productSel.onchange = updateCost;
            updateCost();
        }

        const renderItems = () => {
            const tbody = document.getElementById('purchase-items-table').querySelector('tbody');
            let total = 0;
            tbody.innerHTML = items.map((item, index) => {
                const prod = products.find(pr => pr.id === item.productId);
                const amount = item.qty * item.cost;
                total += amount;
                return `<tr><td>${prod?prod.name:'N/A'}</td><td class="right">${item.qty}</td><td class="right">‚Çπ ${fmt(item.cost)}</td><td class="right">‚Çπ ${fmt(amount)}</td></tr>`;
            }).join('');
            document.getElementById('total').textContent = `‚Çπ ${fmt(total)}`;
        };

        window.removePurchaseItem = (index) => { items.splice(index, 1); renderItems(); };
        document.getElementById('add-item-btn').onclick = () => {
            const productId = productSel.value;
            const qty = Number(document.getElementById('item-qty').value);
            const cost = Number(document.getElementById('item-cost').value);
            const product = products.find(p => p.id === productId);
            if (!productId || qty <= 0 || cost < 0) return showToast('Invalid item details');
            // Capture the price at the time of purchase for profit calculation
            items.push({ productId, qty, cost, price: product?.price || 0 });
            renderItems();
        };
        
        document.getElementById('save-purchase-btn').onclick = () => {
            const purchases = load('purchases');
            const prods = load('products');
            const formData = new FormData(document.getElementById('purchase-form'));
            const newPurchase = {
                id: p.id || uid('pr'),
                supplierId: formData.get('supplierId'), bill: formData.get('bill'), date: formData.get('date'),
                items,
                total: items.reduce((acc, i) => acc + i.qty * i.cost, 0),
                paid: Number(document.getElementById('amount-paid').value)
            };

            // CRITICAL: Update stock on purchase
            newPurchase.items.forEach(item => {
                const pIndex = prods.findIndex(p => p.id === item.productId);
                if (pIndex > -1) prods[pIndex].stock = Number(prods[pIndex].stock || 0) + item.qty;
            });
            save('products', prods);
            
            save('purchases', p.id ? purchases.map(pu => pu.id === p.id ? newPurchase : pu) : [newPurchase, ...purchases]);
            showToast('Purchase saved!');
            render('purchases');
        };
        renderItems();
    }
    
    // ========== RENDER: PAYMENTS & RECEIPTS ==========
    function renderPayments({ payments, sales, purchases, customers, suppliers }) {
      main.innerHTML = `
        <h2>Payments & Receipts</h2>
        <div class="card">
          <div class="row">
            <div style="flex:1"><label>Type</label><select id="pt-type"><option value="receipt">Receipt (from Customer)</option><option value="payment">Payment (to Supplier)</option></select></div>
            <div style="flex:2"><label>Reference (Invoice/Bill)</label><select id="pt-ref"></select></div>
            <div style="flex:1"><label>Date</label><input id="pt-date" type="date" value="${today()}"/></div>
          </div>
          <div class="row" style="margin-top:8px; align-items:flex-end;">
            <div style="flex:1"><label>Amount (‚Çπ)</label><input id="pt-amt" type="number" step="0.01"/></div>
            <div style="flex:1"><label>Method</label><input id="pt-method" placeholder="Cash/Bank/UPI"/></div>
            <div><button id="pt-save" class="btn primary">Record Payment</button></div>
          </div>
        </div>
        <div class="card">
          <h3>All Transactions</h3>
          <table>
            <thead><tr><th>Date</th><th>Type</th><th>Reference</th><th class="right">Amount</th><th>Method</th></tr></thead>
            <tbody>${payments.map(pm => {
                let refLabel = '‚Äì';
                if (pm.refType === 'sale') {
                    const inv = sales.find(s => s.id === pm.refId);
                    const cust = customers.find(c => c.id === inv?.customerId);
                    refLabel = inv ? `INV ${inv.invoice} (${cust?.name})` : 'Sale';
                } else if (pm.refType === 'purchase') {
                    const bill = purchases.find(b => b.id === pm.refId);
                    const sup = suppliers.find(s => s.id === bill?.supplierId);
                    refLabel = bill ? `BILL ${bill.bill} (${sup?.name})` : 'Purchase';
                }
                return `<tr><td>${pm.date}</td><td>${pm.type}</td><td>${refLabel}</td><td class="right">‚Çπ ${fmt(pm.amount)}</td><td>${pm.method}</td></tr>`;
            }).join('')}</tbody>
          </table>
        </div>`;
    
      const refSel = document.getElementById('pt-ref');
      const populateRefs = () => {
        refSel.innerHTML = '';
        const type = document.getElementById('pt-type').value;
        const options = type === 'receipt' ?
            sales.map(inv => ({ inv, due: (inv.total || 0) - (inv.paid || 0), cust: customers.find(c => c.id === inv.customerId) }))
                 .filter(x => x.due > 0.01)
                 .map(x => `<option value="sale:${x.inv.id}">INV ${x.inv.invoice} - ${x.cust?.name} (Due ‚Çπ ${fmt(x.due)})</option>`) :
            purchases.map(bill => ({ bill, due: (bill.total || 0) - (bill.paid || 0), sup: suppliers.find(s => s.id === bill.supplierId) }))
                 .filter(x => x.due > 0.01)
                 .map(x => `<option value="purchase:${x.bill.id}">BILL ${x.bill.bill} - ${x.sup?.name} (Due ‚Çπ ${fmt(x.due)})</option>`);
        refSel.innerHTML = options.join('') || '<option value="">No outstanding references</option>';
      };
    
      document.getElementById('pt-type').onchange = populateRefs;
      populateRefs();
    
      document.getElementById('pt-save').onclick = () => {
        const ref = document.getElementById('pt-ref').value;
        if (!ref) return showToast('Select a reference');
        const [rType, id] = ref.split(':');
        const amount = Number(document.getElementById('pt-amt').value || 0);
        if (amount <= 0) return showToast('Enter a valid amount');
    
        const payment = { id: uid('pay'), type: rType === 'sale' ? 'receipt' : 'payment', refType: rType, refId: id, date: document.getElementById('pt-date').value, amount, method: document.getElementById('pt-method').value || 'Cash' };
        save('payments', [payment, ...load('payments')]);
    
        const arrKey = rType === 'sale' ? 'sales' : 'purchases';
        const arr = load(arrKey);
        const item = arr.find(x => x.id === id);
        if (item) item.paid = (Number(item.paid) || 0) + amount;
        save(arrKey, arr);
    
        showToast('Payment recorded');
        render('payments');
      };
    }
    
    // ========== RENDER: REPORTS & EXPORT ==========
    function renderReports() {
        main.innerHTML = `
            <h2>Reports & Data Management</h2>
            <div class="card">
                <h3>Export Data</h3>
                <p class="small">Download all your data (products, sales, etc.) into a single JSON file for backup.</p>
                <button class="btn primary" id="export-btn">Export All Data</button>
            </div>
            <div class="card">
                <h3>Import Data</h3>
                <p class="small">Import data from a previously exported JSON file. <b style="color:#ef4444">Warning: This will overwrite all current data.</b></p>
                <input type="file" id="import-file" accept=".json">
                <button class="btn danger" id="import-btn" style="margin-top:8px;">Import and Overwrite</button>
            </div>
            <div class="card">
                <h3>Ledger Search</h3>
                <p class="small">View all transactions (sales, purchases, payments) in a single list.</p>
                <button class="btn primary" onclick="render('ledger')">Go to Ledger</button>
            </div>
            `;
    
        document.getElementById('export-btn').onclick = () => {
            const data = LS_KEYS.reduce((acc, k) => ({ ...acc, [k]: load(k) }), {});
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup-${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Data exported!');
        };
    
        document.getElementById('import-btn').onclick = () => {
            const fileInput = document.getElementById('import-file');
            if (fileInput.files.length === 0) return showToast('Please select a file to import.');
            const importConfirm = confirm('ARE YOU SURE?\nThis will permanently delete all current data and replace it with the data from the file.');
            if (!importConfirm) return;
    
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const data = JSON.parse(e.target.result);
                    let imported = 0;
                    for (const key of LS_KEYS) {
                        if (data[key] && Array.isArray(data[key])) {
                            save(key, data[key]);
                            imported++;
                        }
                    }
                    if (imported > 0) {
                        showToast('Data successfully imported! The app will now reload.');
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        showToast('Import failed: Invalid file format.');
                    }
                } catch (err) {
                    showToast('Import failed: Could not parse the file.');
                }
            };
            reader.readAsText(fileInput.files[0]);
        };
    }
    
    // ========== RENDER: LEDGER SEARCH ==========
    function renderLedger({ sales, purchases, payments, customers, suppliers }) {
        // Combine all transactions into a single ledger list
        const ledger = [
            ...sales.map(s => ({ ...s, type: 'Sale', date: s.date, total: s.total, contactId: s.customerId })),
            ...purchases.map(p => ({ ...p, type: 'Purchase', date: p.date, total: p.total, contactId: p.supplierId })),
            ...payments.map(pm => ({ ...pm, type: pm.type, total: pm.amount, contactId: pm.refType === 'sale' ? sales.find(s => s.id === pm.refId)?.customerId : purchases.find(p => p.id === pm.refId)?.supplierId }))
        ];
        
        // Sort ledger by date in descending order
        ledger.sort((a, b) => new Date(b.date) - new Date(a.date));

        const getContactName = (id) => {
            const customer = customers.find(c => c.id === id);
            if (customer) return customer.name;
            const supplier = suppliers.find(s => s.id === id);
            if (supplier) return supplier.name;
            return 'N/A';
        };

        main.innerHTML = `
            <h2>Ledger Search</h2>
            <div class="card">
                <h3>Transaction History</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Contact</th>
                            <th class="right">Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${ledger.map(item => `
                            <tr>
                                <td>${item.date}</td>
                                <td>${item.type}</td>
                                <td>${getContactName(item.contactId)}</td>
                                <td class="right">‚Çπ ${fmt(item.total)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }

    // ========== APP INITIALIZATION ==========
    (function init() {
        if (localStorage.getItem('theme') === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
        }
        initIfEmpty();
        render('dashboard');
    })();
  </script>
</body>
</html>
