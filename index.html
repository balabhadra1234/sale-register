<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Sales & Purchase ‚Äî Fixed</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --accent: #2b7a78; --muted: #6b7280; --border: #e5e7eb; --bg: #f9fafb;
      --card-bg: #ffffff; --text: #111827; --shadow: rgba(15, 23, 42, 0.06);
      --sales: #28a745;
      --purchases: #007bff;
      --profit: #ffc107;
      --receivables: #dc3545;
      --payables: #6c757d;
    }
    [data-theme="dark"] {
      --accent: #14a8a5; --muted: #9ca3af; --border: #374151; --bg: #111827;
      --card-bg: #1f2937; --text: #f3f4f6; --shadow: rgba(0, 0, 0, 0.2);
      --sales: #28a745;
      --purchases: #007bff;
      --profit: #ffc107;
      --receivables: #dc3545;
      --payables: #6c757d;
    }
    body {
        font-family: 'Inter', system-ui, sans-serif;
        margin: 0;
        background: var(--bg);
        color: var(--text);
        transition: background 0.3s ease;
        line-height: 1.6;
    }
    header {
        background: var(--accent);
        color: white;
        padding: 14px 18px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        position: sticky;
        top: 0;
        z-index: 10;
    }
    header h1 {
        font-size: 18px;
        font-weight: 600;
        margin: 0;
    }
    .wrap {
        display: flex;
        gap: 16px;
        padding: 16px;
        align-items: flex-start;
    }
    nav {
        width: 260px;
        background: var(--card-bg);
        padding: 12px;
        border-radius: 12px;
        box-shadow: 0 6px 18px var(--shadow);
        position: sticky;
        top: 60px;
    }
    nav button {
        display: flex;
        gap: 10px;
        align-items: center;
        width: 100%;
        padding: 10px 12px;
        border-radius: 8px;
        border: none;
        background: transparent;
        cursor: pointer;
        color: var(--text);
        font-size: 14px;
        text-align: left;
        transition: all 0.2s;
    }
    nav button:hover {
        background: rgba(43, 122, 120, 0.08);
    }
    nav button.active {
        background: linear-gradient(90deg, rgba(43,122,120,.1), rgba(43,122,120,.05));
        font-weight: 600;
        color: var(--accent);
    }
    main {
        flex: 1;
        background: var(--card-bg);
        padding: 16px;
        border-radius: 12px;
        box-shadow: 0 6px 18px var(--shadow);
    }
    h2 {
        margin: 0 0 16px 0;
        font-size: 20px;
        font-weight: 600;
    }
    h3 {
        font-size: 16px;
        font-weight: 600;
        margin-top: 0;
    }
    .row {
        display: flex;
        gap: 12px;
        margin-bottom: 8px;
        flex-wrap: wrap;
    }
    label {
        display: block;
        font-size: 13px;
        font-weight: 500;
        margin-bottom: 4px;
    }
    input, select, textarea, button {
        font-family: inherit;
        font-size: 14px;
    }
    input, select, textarea {
        padding: 10px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: var(--bg);
        color: var(--text);
        width: 100%;
        box-sizing: border-box;
    }
    input:focus, select:focus, textarea:focus {
        outline: 2px solid var(--accent);
        border-color: var(--accent);
    }
    button.btn {
        padding: 10px 14px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-weight: 500;
    }
    button.primary { background: var(--accent); color: white; }
    button.ghost { background: transparent; border: 1px solid var(--border); color: var(--text); }
    button.danger { background: #ef4444; color: white; }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 16px;
    }
    th, td {
        padding: 10px;
        border-bottom: 1px solid var(--border);
        text-align: left;
        font-size: 14px;
    }
    th {
        background: var(--bg);
        font-weight: 600;
    }
    .right { text-align: right; }
    .center { text-align: center; }
    .small { font-size: 12px; color: var(--muted); }
    .bold { font-weight: 600; }
    .card {
        background: var(--card-bg);
        padding: 16px;
        border-radius: 10px;
        box-shadow: 0 4px 12px var(--shadow);
        margin-bottom: 16px;
    }
    .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 16px;
        border-radius: 8px;
        background: #333;
        color: white;
        z-index: 100;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        opacity: 0;
        transform: translateY(-10px);
        transition: all 0.3s ease;
    }
    .toast.show {
        opacity: 1;
        transform: translateY(0);
    }
    footer {
        padding: 16px;
        text-align: center;
        color: var(--muted);
        font-size: 13px;
    }
    .theme-toggle {
        background: rgba(255,255,255,0.2);
        border: 1px solid rgba(255,255,255,0.3);
        color: white;
        padding: 6px 10px;
        border-radius: 8px;
        cursor: pointer;
    }
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 16px;
    }
    .dashboard-card {
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        color: white;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }
    .dashboard-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 6px 16px rgba(0,0,0,0.1);
    }
    .dashboard-card::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.1);
        transition: background 0.3s ease;
        pointer-events: none;
    }
    .dashboard-card:hover::after {
        background: rgba(0, 0, 0, 0);
    }
    .dashboard-card h3 {
        margin: 0;
        font-size: 14px;
        font-weight: 500;
        opacity: 0.8;
    }
    .dashboard-card .value {
        font-size: 28px;
        font-weight: 700;
        margin-top: 8px;
    }
    .dashboard-sales { background: linear-gradient(135deg, #28a745, #218838); }
    .dashboard-purchases { background: linear-gradient(135deg, #007bff, #0056b3); }
    .dashboard-profit { background: linear-gradient(135deg, #ffc107, #d39e00); }
    .dashboard-receivables { background: linear-gradient(135deg, #dc3545, #c82333); }
    .dashboard-payables { background: linear-gradient(135deg, #6c757d, #5a6268); }

    .clickable { cursor: pointer; }

    @media (max-width: 880px) {
        .wrap {
            flex-direction: column;
            padding: 8px;
        }
        nav {
            width: 100%;
            position: relative;
            top: 0;
            margin-bottom: 16px;
        }
        main {
            width: 100%;
            padding: 12px;
        }
        header h1 {
            font-size: 16px;
        }
        .dashboard-grid {
            grid-template-columns: 1fr;
        }
        .row {
            flex-direction: column;
        }
        .row > div {
            width: 100%;
        }
        table {
            font-size: 12px;
        }
        th, td {
            padding: 8px 6px;
        }
    }

    @media print {
        body * { visibility: hidden; }
        #printable-area, #printable-area * { visibility: visible; }
        #printable-area { position: absolute; left: 0; top: 0; width: 100%; }
        .no-print { display: none; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Sales & Purchase Management</h1>
    <button class="theme-toggle" onclick="toggleTheme()">üåô / ‚òÄÔ∏è</button>
  </header>

  <div class="wrap">
    <nav id="nav" class="no-print">
      <button data-tab="dashboard" class="active">Dashboard</button>
      <button data-tab="products">Products & Stock</button>
      <button data-tab="customers">Customers</button>
      <button data-tab="suppliers">Suppliers</button>
      <button data-tab="sales">Sales Invoices</button>
      <button data-tab="purchases">Purchase Bills</button>
      <button data-tab="payments">Payments & Receipts</button>
      <button data-tab="reports">Reports & Export</button>
    </nav>
    <main id="main"></main>
  </div>

  <footer class="no-print">Fully offline. Data saved in browser. Export/Import JSON in Reports.</footer>
  <div id="toast" class="toast no-print"></div>

  <script>
    const main = document.getElementById('main');
    const nav = document.getElementById('nav');

    // ========== UTILS & CORE ==========
    const uid = (p = 'id') => p + Date.now().toString(36) + Math.random().toString(36).slice(2, 6);
    const fmt = n => Number(n || 0).toLocaleString('en-IN', { maximumFractionDigits: 2, minimumFractionDigits: 2 });
    const today = () => new Date().toISOString().slice(0, 10);
    const LS_KEYS = ['products', 'customers', 'suppliers', 'sales', 'purchases', 'payments'];

    function load(key) { try { return JSON.parse(localStorage.getItem(key) || '[]'); } catch { return []; } }
    function save(key, arr) { localStorage.setItem(key, JSON.stringify(arr || [])); }
    function showToast(msg) {
        const toast = document.getElementById('toast');
        toast.textContent = msg;
        toast.className = 'toast show';
        setTimeout(() => { toast.className = 'toast'; }, 3000);
    }
    function toggleTheme() {
        const root = document.documentElement;
        const isDark = root.getAttribute('data-theme') === 'dark';
        root.setAttribute('data-theme', isDark ? 'light' : 'dark');
        localStorage.setItem('theme', isDark ? 'light' : 'dark');
    }

    // New helper function to calculate profit for a single transaction (sale or purchase)
    function calculateProfit(items, products, type) {
        return items.reduce((totalProfit, item) => {
            const product = products.find(p => p.id === item.productId);
            if (!product) return totalProfit;
            const itemCost = product.cost;
            const itemPrice = product.price;

            if (type === 'sale') {
                const profitPerItem = (item.price - itemCost) || 0;
                return totalProfit + (profitPerItem * (item.qty || 0));
            } else if (type === 'purchase') {
                // This logic seems inverted for purchase, assuming you meant something else
                // For now, let's assume profit is only calculated on sales for simplicity.
                return totalProfit;
            }
            return totalProfit;
        }, 0);
    }

    // ========== INITIAL DATA SETUP ==========
    function initIfEmpty() {
        if (!load('products').length) save('products', [
            { id: uid('p'), sku: 'P-001', name: 'Widget A', category: 'General', price: 100, cost: 70, stock: 50, unit: 'pcs', minStock: 5 },
            { id: uid('p'), sku: 'P-002', name: 'Widget B', category: 'General', price: 200, cost: 140, stock: 30, unit: 'pcs', minStock: 5 }
        ]);
        if (!load('customers').length) save('customers', [{ id: uid('c'), name: 'Walk-in Customer', phone: '', email: '' }]);
        LS_KEYS.forEach(k => { if (!localStorage.getItem(k)) save(k, []); });
    }

    // ========== NAVIGATION & ROUTING ==========
    nav.addEventListener('click', e => {
        const btn = e.target.closest('button[data-tab]');
        if (!btn) return;
        nav.querySelectorAll('button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        render(btn.dataset.tab);
    });

    function render(tab, id) {
        const data = LS_KEYS.reduce((acc, k) => ({ ...acc, [k]: load(k) }), {});
        const renderer = {
            dashboard: renderDashboard,
            products: renderProducts,
            customers: renderCustomers,
            suppliers: renderSuppliers,
            sales: renderSales,
            new_sale: renderSaleForm,
            purchases: renderPurchases,
            new_purchase: renderPurchaseForm,
            payments: renderPayments,
            reports: renderReports,
            ledger: renderLedgerSelection,
            contact_ledger: renderContactLedger,
            receivables: renderReceivables,
            payables: renderPayables,
        }[tab];
        if (renderer) renderer(data, id);
    }
    window.redirect = render;

    // ========== RENDER: DASHBOARD ==========
    function renderDashboard({ products, sales, purchases, customers, suppliers }) {
      const fromDate = document.getElementById('from-date')?.value || today();
      const toDate = document.getElementById('to-date')?.value || today();

      const filteredSales = sales.filter(s => s.date >= fromDate && s.date <= toDate);
      const filteredPurchases = purchases.filter(p => p.date >= fromDate && p.date <= toDate);

      const totalSales = filteredSales.reduce((s,x) => s + Number(x.total||0), 0);
      const totalPurchases = filteredPurchases.reduce((s,x) => s + Number(x.total||0), 0);
      const profit = filteredSales.reduce((s, x) => s + calculateProfit(x.items, products, 'sale'), 0);

      const receivables = sales.reduce((s,x) => s + (Number(x.total||0) - Number(x.paid||0)), 0);
      const payables = purchases.reduce((s,x) => s + (Number(x.total||0) - Number(x.paid||0)), 0);
      const lowStock = products.filter(p => Number(p.stock||0) <= Number(p.minStock||0));

      main.innerHTML = `
        <h2>Dashboard</h2>
        <div class="card">
            <h3 style="margin-top:0">Date Range</h3>
            <div class="row">
                <div style="flex:1"><label>From</label><input type="date" id="from-date" value="${fromDate}"></div>
                <div style="flex:1"><label>To</label><input type="date" id="to-date" value="${toDate}"></div>
                <div style="margin-top:21px;"><button class="btn primary" id="filter-btn">Apply Filter</button></div>
            </div>
        </div>
        <div class="dashboard-grid">
            <div class="dashboard-card dashboard-sales clickable" onclick="redirect('sales')">
                <h3>Total Sales</h3>
                <div class="value">‚Çπ ${fmt(totalSales)}</div>
            </div>
            <div class="dashboard-card dashboard-purchases clickable" onclick="redirect('purchases')">
                <h3>Total Purchases</h3>
                <div class="value">‚Çπ ${fmt(totalPurchases)}</div>
            </div>
            <div class="dashboard-card dashboard-profit">
                <h3>Profit</h3>
                <div class="value">‚Çπ ${fmt(profit)}</div>
            </div>
            <div class="dashboard-card dashboard-receivables clickable" onclick="redirect('receivables')">
                <h3>Receivables</h3>
                <div class="value">‚Çπ ${fmt(receivables)}</div>
            </div>
            <div class="dashboard-card dashboard-payables clickable" onclick="redirect('payables')">
                <h3>Payables</h3>
                <div class="value">‚Çπ ${fmt(payables)}</div>
            </div>
        </div>
        <div class="card">
          <h3 style="margin-top:0">Low Stock Alerts</h3>
          ${lowStock.length ? `<table><thead><tr><th>SKU</th><th>Product</th><th class="right">Stock</th><th class="right">Min Stock</th></tr></thead><tbody>${lowStock.map(p => `
                <tr><td>${p.sku}</td><td>${p.name}</td><td class="right">${p.stock} ${p.unit}</td><td class="right">${p.minStock}</td></tr>`).join('')}</tbody></table>`
                 : '<div class="small">No low stock items</div>'}
        </div>`;

        document.getElementById('filter-btn').onclick = () => render('dashboard');
    }

    // ========== RENDER: GENERIC CRUD (FOR PRODUCTS, CUSTOMERS, SUPPLIERS) ==========
    function renderCRUD(opts) {
        const items = load(opts.key);
        main.innerHTML = `
            <h2>${opts.title}</h2>
            <div class="card">
                <form id="crud-form">
                    <input type="hidden" name="id">
                    <div class="row">${opts.fields.map(f => `<div style="flex:${f.flex||1}"><label>${f.label}</label><input name="${f.name}" type="${f.type||'text'}" placeholder="${f.placeholder||''}"></div>`).join('')}</div>
                    <div class="row" style="justify-content:flex-end; margin-top:16px;">
                      <button type="button" class="btn ghost" onclick="this.closest('form').reset()">Clear</button>
                      <button type="submit" class="btn primary">Save ${opts.singular}</button>
                    </div>
                </form>
            </div>
            <div class="card">
                <h3>All ${opts.title}</h3>
                <table>
                    <thead><tr>${opts.headers.map(h => `<th>${h}</th>`).join('')}<th>Actions</th></tr></thead>
                    <tbody>${items.map(it => `<tr>${opts.row(it).map(td => `<td>${td}</td>`).join('')}
                        <td><button class="btn ghost small" onclick="editItem('${opts.key}', '${it.id}')">Edit</button> <button class="btn danger small" onclick="deleteItem('${opts.key}', '${it.id}')">Del</button></td>
                    </tr>`).join('')}</tbody>
                </table>
            </div>`;

        document.getElementById('crud-form').onsubmit = e => {
            e.preventDefault();
            const form = e.target;
            const item = Object.fromEntries(new FormData(form));
            const allItems = load(opts.key);
            if (item.id) {
                save(opts.key, allItems.map(i => i.id === item.id ? { ...i, ...item } : i));
            } else {
                item.id = uid(opts.key[0]);
                allItems.unshift(item);
                save(opts.key, allItems);
            }
            showToast(`${opts.singular} saved.`);
            render(opts.key);
        };
    }

    window.editItem = (key, id) => {
        const item = load(key).find(i => i.id === id);
        if (!item) return;
        const form = document.getElementById('crud-form');
        for (const prop in item) {
            if (form.elements[prop]) form.elements[prop].value = item[prop];
        }
        window.scrollTo(0, 0);
    }
    window.deleteItem = (key, id) => {
        if (!confirm('Are you sure you want to delete this item?')) return;
        save(key, load(key).filter(i => i.id !== id));
        showToast('Item deleted.');
        render(key);
    }

    // ========== RENDER: PRODUCTS, CUSTOMERS, SUPPLIERS (USING GENERIC CRUD) ==========
    function renderProducts() {
        renderCRUD({
            key: 'products', title: 'Products & Stock', singular: 'Product',
            fields: [
                { name: 'sku', label: 'SKU', flex: 1 }, { name: 'name', label: 'Product Name', flex: 2 },
                { name: 'price', label: 'Sale Price (‚Çπ)', type: 'number', flex: 1 }, { name: 'cost', label: 'Cost Price (‚Çπ)', type: 'number', flex: 1 },
                { name: 'stock', label: 'Stock', type: 'number', flex: 1 }, { name: 'minStock', label: 'Min Stock', type: 'number', flex: 1 },
                { name: 'unit', label: 'Unit (pcs, kg)', flex: 1 },
            ],
            headers: ['SKU', 'Name', 'Sale Price', 'Cost', 'Stock'],
            row: p => [p.sku, p.name, `‚Çπ ${fmt(p.price)}`, `‚Çπ ${fmt(p.cost)}`, `${p.stock||0} ${p.unit||''}`]
        });
    }
    function renderCustomers() {
        renderCRUD({
            key: 'customers', title: 'Customers', singular: 'Customer',
            fields: [ { name: 'name', label: 'Name', flex: 2 }, { name: 'phone', label: 'Phone', flex: 1 }, { name: 'email', label: 'Email', flex: 1 } ],
            headers: ['Name', 'Phone', 'Email'],
            row: c => [c.name, c.phone, c.email]
        });
    }
    function renderSuppliers() {
        renderCRUD({
            key: 'suppliers', title: 'Suppliers', singular: 'Supplier',
            fields: [ { name: 'name', label: 'Name', flex: 2 }, { name: 'phone', label: 'Phone', flex: 1 }, { name: 'email', label: 'Email', flex: 1 } ],
            headers: ['Name', 'Phone', 'Email'],
            row: s => [s.name, s.phone, s.email]
        });
    }

    // ========== RENDER: SALES LIST ==========
    function renderSales({ sales, customers, products }) {
        main.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                <h2>Sales Invoices</h2>
                <button class="btn primary no-print" onclick="render('new_sale')">New Invoice</button>
            </div>
            <div class="card">
                <table>
                    <thead><tr><th>Date</th><th>Invoice #</th><th>Customer</th><th class="right">Total</th><th class="right">Profit</th><th class="right">Due</th></tr></thead>
                    <tbody>
                        ${sales.map(s => {
                            const cust = customers.find(c => c.id === s.customerId)?.name || 'N/A';
                            const due = (s.total || 0) - (s.paid || 0);
                            const profit = calculateProfit(s.items, products, 'sale');
                            return `<tr class="clickable" onclick="render('new_sale', '${s.id}')">
                                <td>${s.date}</td>
                                <td>${s.invoice}</td>
                                <td>${cust}</td>
                                <td class="right">‚Çπ ${fmt(s.total)}</td>
                                <td class="right">‚Çπ ${fmt(profit)}</td>
                                <td class="right" style="color:${due > 0 ? '#ef4444' : 'inherit'}">‚Çπ ${fmt(due)}</td>
                            </tr>`
                        }).join('')}
                    </tbody>
                </table>
            </div>`;
    }

    // ========== RENDER: NEW/EDIT SALE FORM ==========
    function renderSaleForm({ products, customers }, saleId) {
        let sale = load('sales').find(s => s.id === saleId) || { id: '', date: today(), customerId: '', invoice: '', paid: 0, total: 0, items: [] };

        const generateItemsTable = (items) => `
            <table>
                <thead>
                    <tr>
                        <th>Product</th>
                        <th class="right">Price</th>
                        <th class="right">Qty</th>
                        <th class="right">Subtotal</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="sale-items-table-body">
                    ${items.map(item => {
                        const product = products.find(p => p.id === item.productId);
                        return `
                            <tr>
                                <td>${product?.name || 'N/A'}</td>
                                <td class="right">‚Çπ ${fmt(item.price)}</td>
                                <td class="right">${item.qty} ${product?.unit || ''}</td>
                                <td class="right">‚Çπ ${fmt(item.price * item.qty)}</td>
                                <td><button type="button" class="btn danger small" onclick="removeSaleItem('${item.id}')">Remove</button></td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        `;

        main.innerHTML = `
            <h2>${saleId ? 'Edit Sale' : 'New Sale'}</h2>
            <div class="card">
                <form id="sale-form">
                    <input type="hidden" name="id" value="${sale.id}">
                    <div class="row">
                        <div style="flex:1"><label>Invoice #</label><input type="text" name="invoice" value="${sale.invoice}" required></div>
                        <div style="flex:1"><label>Date</label><input type="date" name="date" value="${sale.date}" required></div>
                        <div style="flex:1"><label>Customer</label><select name="customerId" required>${customers.map(c => `<option value="${c.id}" ${sale.customerId === c.id ? 'selected' : ''}>${c.name}</option>`).join('')}</select></div>
                    </div>
                    <hr style="border:0;border-top:1px solid var(--border);margin:16px 0;">
                    <div class="row">
                        <div style="flex:2"><label>Add Product</label><select id="product-select"><option value="">Select a Product</option>${products.map(p => `<option value="${p.id}">${p.name} (Stock: ${p.stock})</option>`).join('')}</select></div>
                        <div style="flex:1"><label>Quantity</label><input type="number" id="qty-input" min="1" value="1"></div>
                        <div style="flex:1"><label>Price (‚Çπ)</label><input type="number" id="price-input" min="0" step="0.01"></div>
                        <div style="margin-top:21px;"><button type="button" class="btn primary" id="add-item-btn">Add Item</button></div>
                    </div>
                </form>
                <div id="sale-items-container">
                    ${sale.items.length ? generateItemsTable(sale.items) : '<div class="small" style="margin-top:16px;">No items added yet.</div>'}
                </div>
                <div class="row" style="justify-content:flex-end; font-size:18px; font-weight:600; margin-top:16px;">Total: ‚Çπ <span id="total-display">${fmt(sale.total)}</span></div>
                <div class="row" style="justify-content:flex-end; align-items:flex-end; gap:8px;">
                    <div style="flex:1;"><label>Amount Paid (‚Çπ)</label><input type="number" id="paid-input" min="0" step="0.01" value="${sale.paid}"></div>
                    <div style="margin-top:21px;"><button type="button" class="btn primary" id="save-sale-btn">Save Invoice</button></div>
                    ${saleId ? `<div style="margin-top:21px;"><button type="button" class="btn danger" onclick="deleteItem('sales', '${saleId}')">Delete Invoice</button></div>` : ''}
                </div>
            </div>
            <div id="sale-toast" class="toast"></div>`;

        const productSelect = document.getElementById('product-select');
        const qtyInput = document.getElementById('qty-input');
        const priceInput = document.getElementById('price-input');
        const addItemBtn = document.getElementById('add-item-btn');
        const paidInput = document.getElementById('paid-input');
        const saveSaleBtn = document.getElementById('save-sale-btn');

        let currentSale = sale;

        const updateTotals = () => {
            currentSale.total = currentSale.items.reduce((sum, item) => sum + (Number(item.price) * Number(item.qty)), 0);
            document.getElementById('total-display').textContent = fmt(currentSale.total);
            paidInput.value = currentSale.paid || 0;
        };

        const renderItems = () => {
            const container = document.getElementById('sale-items-container');
            container.innerHTML = currentSale.items.length ? generateItemsTable(currentSale.items) : '<div class="small" style="margin-top:16px;">No items added yet.</div>';
            updateTotals();
        };

        productSelect.onchange = () => {
            const product = products.find(p => p.id === productSelect.value);
            if (product) {
                priceInput.value = product.price;
                qtyInput.value = 1;
            } else {
                priceInput.value = '';
                qtyInput.value = 1;
            }
        };

        addItemBtn.onclick = () => {
            const productId = productSelect.value;
            const qty = Number(qtyInput.value);
            const price = Number(priceInput.value);

            if (!productId || qty <= 0 || price < 0) {
                showToast('Please select a product and enter valid quantity/price.');
                return;
            }

            const product = products.find(p => p.id === productId);
            if (qty > product.stock) {
                showToast(`Not enough stock! Max available: ${product.stock}`);
                return;
            }

            const existingItem = currentSale.items.find(item => item.productId === productId);
            if (existingItem) {
                existingItem.qty = Number(existingItem.qty) + qty;
                existingItem.price = price;
            } else {
                currentSale.items.push({ id: uid(), productId, qty, price });
            }
            renderItems();
            productSelect.value = '';
            qtyInput.value = 1;
            priceInput.value = '';
        };

        window.removeSaleItem = (itemId) => {
            currentSale.items = currentSale.items.filter(item => item.id !== itemId);
            renderItems();
        };

        saveSaleBtn.onclick = () => {
            const form = document.getElementById('sale-form');
            const formData = new FormData(form);
            const invoice = formData.get('invoice');
            const date = formData.get('date');
            const customerId = formData.get('customerId');
            const paid = Number(paidInput.value);

            if (!invoice || !date || !customerId || currentSale.items.length === 0) {
                showToast('Please fill out all fields and add at least one item.');
                return;
            }

            const allSales = load('sales');
            const allProducts = load('products');
            const updatedProducts = [...allProducts];

            currentSale.invoice = invoice;
            currentSale.date = date;
            currentSale.customerId = customerId;
            currentSale.paid = paid;

            if (saleId) { // Edit existing sale
                const originalSale = allSales.find(s => s.id === saleId);
                const salesItemsDiff = getItemsDiff(originalSale.items, currentSale.items);

                salesItemsDiff.added.forEach(item => {
                    const product = updatedProducts.find(p => p.id === item.productId);
                    if (product) product.stock = Number(product.stock) - Number(item.qty);
                });
                salesItemsDiff.removed.forEach(item => {
                    const product = updatedProducts.find(p => p.id === item.productId);
                    if (product) product.stock = Number(product.stock) + Number(item.qty);
                });
                salesItemsDiff.updated.forEach(item => {
                    const product = updatedProducts.find(p => p.id === item.productId);
                    if (product) product.stock = Number(product.stock) + Number(item.oldQty) - Number(item.newQty);
                });

                save('sales', allSales.map(s => s.id === saleId ? currentSale : s));

            } else { // New sale
                currentSale.id = uid('s');
                allSales.unshift(currentSale);
                save('sales', allSales);

                currentSale.items.forEach(item => {
                    const product = updatedProducts.find(p => p.id === item.productId);
                    if (product) product.stock = Number(product.stock) - Number(item.qty);
                });
            }

            save('products', updatedProducts);
            showToast('Invoice saved successfully.');
            render('sales');
        };
    }

    // Helper to compare item lists for stock adjustments
    function getItemsDiff(oldItems, newItems) {
        const added = newItems.filter(newItem => !oldItems.find(oldItem => oldItem.productId === newItem.productId));
        const removed = oldItems.filter(oldItem => !newItems.find(newItem => newItem.productId === oldItem.productId));
        const updated = newItems.filter(newItem => {
            const oldItem = oldItems.find(oldItem => oldItem.productId === newItem.productId);
            return oldItem && oldItem.qty !== newItem.qty;
        }).map(newItem => ({
            ...newItem,
            oldQty: oldItems.find(oldItem => oldItem.productId === newItem.productId).qty,
            newQty: newItem.qty
        }));
        return { added, removed, updated };
    }

    // ========== RENDER: PURCHASE BILLS ==========
    function renderPurchases({ purchases, suppliers, products }) {
        main.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                <h2>Purchase Bills</h2>
                <button class="btn primary no-print" onclick="render('new_purchase')">New Bill</button>
            </div>
            <div class="card">
                <table>
                    <thead><tr><th>Date</th><th>Bill #</th><th>Supplier</th><th class="right">Total</th><th class="right">Due</th></tr></thead>
                    <tbody>
                        ${purchases.map(p => {
                            const sup = suppliers.find(s => s.id === p.supplierId)?.name || 'N/A';
                            const due = (p.total || 0) - (p.paid || 0);
                            return `<tr class="clickable" onclick="render('new_purchase', '${p.id}')">
                                <td>${p.date}</td>
                                <td>${p.bill}</td>
                                <td>${sup}</td>
                                <td class="right">‚Çπ ${fmt(p.total)}</td>
                                <td class="right" style="color:${due > 0 ? '#ef4444' : 'inherit'}">‚Çπ ${fmt(due)}</td>
                            </tr>`;
                        }).join('')}
                    </tbody>
                </table>
            </div>`;
    }

    // ========== RENDER: NEW/EDIT PURCHASE FORM ==========
    function renderPurchaseForm({ products, suppliers }, purchaseId) {
        let purchase = load('purchases').find(p => p.id === purchaseId) || { id: '', date: today(), supplierId: '', bill: '', paid: 0, total: 0, items: [] };

        const generateItemsTable = (items) => `
            <table>
                <thead>
                    <tr>
                        <th>Product</th>
                        <th class="right">Cost</th>
                        <th class="right">Qty</th>
                        <th class="right">Subtotal</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="purchase-items-table-body">
                    ${items.map(item => {
                        const product = products.find(p => p.id === item.productId);
                        return `
                            <tr>
                                <td>${product?.name || 'N/A'}</td>
                                <td class="right">‚Çπ ${fmt(item.cost)}</td>
                                <td class="right">${item.qty} ${product?.unit || ''}</td>
                                <td class="right">‚Çπ ${fmt(item.cost * item.qty)}</td>
                                <td><button type="button" class="btn danger small" onclick="removePurchaseItem('${item.id}')">Remove</button></td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        `;

        main.innerHTML = `
            <h2>${purchaseId ? 'Edit Bill' : 'New Bill'}</h2>
            <div class="card">
                <form id="purchase-form">
                    <input type="hidden" name="id" value="${purchase.id}">
                    <div class="row">
                        <div style="flex:1"><label>Bill #</label><input type="text" name="bill" value="${purchase.bill}" required></div>
                        <div style="flex:1"><label>Date</label><input type="date" name="date" value="${purchase.date}" required></div>
                        <div style="flex:1"><label>Supplier</label><select name="supplierId" required>${suppliers.map(s => `<option value="${s.id}" ${purchase.supplierId === s.id ? 'selected' : ''}>${s.name}</option>`).join('')}</select></div>
                    </div>
                    <hr style="border:0;border-top:1px solid var(--border);margin:16px 0;">
                    <div class="row">
                        <div style="flex:2"><label>Add Product</label><select id="product-select"><option value="">Select a Product</option>${products.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}</select></div>
                        <div style="flex:1"><label>Quantity</label><input type="number" id="qty-input" min="1" value="1"></div>
                        <div style="flex:1"><label>Cost (‚Çπ)</label><input type="number" id="cost-input" min="0" step="0.01"></div>
                        <div style="margin-top:21px;"><button type="button" class="btn primary" id="add-item-btn">Add Item</button></div>
                    </div>
                </form>
                <div id="purchase-items-container">
                    ${purchase.items.length ? generateItemsTable(purchase.items) : '<div class="small" style="margin-top:16px;">No items added yet.</div>'}
                </div>
                <div class="row" style="justify-content:flex-end; font-size:18px; font-weight:600; margin-top:16px;">Total: ‚Çπ <span id="total-display">${fmt(purchase.total)}</span></div>
                <div class="row" style="justify-content:flex-end; align-items:flex-end; gap:8px;">
                    <div style="flex:1;"><label>Amount Paid (‚Çπ)</label><input type="number" id="paid-input" min="0" step="0.01" value="${purchase.paid}"></div>
                    <div style="margin-top:21px;"><button type="button" class="btn primary" id="save-purchase-btn">Save Bill</button></div>
                    ${purchaseId ? `<div style="margin-top:21px;"><button type="button" class="btn danger" onclick="deleteItem('purchases', '${purchaseId}')">Delete Bill</button></div>` : ''}
                </div>
            </div>
            <div id="purchase-toast" class="toast"></div>`;

        const productSelect = document.getElementById('product-select');
        const qtyInput = document.getElementById('qty-input');
        const costInput = document.getElementById('cost-input');
        const addItemBtn = document.getElementById('add-item-btn');
        const paidInput = document.getElementById('paid-input');
        const savePurchaseBtn = document.getElementById('save-purchase-btn');

        let currentPurchase = purchase;

        const updateTotals = () => {
            currentPurchase.total = currentPurchase.items.reduce((sum, item) => sum + (Number(item.cost) * Number(item.qty)), 0);
            document.getElementById('total-display').textContent = fmt(currentPurchase.total);
            paidInput.value = currentPurchase.paid || 0;
        };

        const renderItems = () => {
            const container = document.getElementById('purchase-items-container');
            container.innerHTML = currentPurchase.items.length ? generateItemsTable(currentPurchase.items) : '<div class="small" style="margin-top:16px;">No items added yet.</div>';
            updateTotals();
        };

        productSelect.onchange = () => {
            const product = products.find(p => p.id === productSelect.value);
            if (product) {
                costInput.value = product.cost;
                qtyInput.value = 1;
            } else {
                costInput.value = '';
                qtyInput.value = 1;
            }
        };

        addItemBtn.onclick = () => {
            const productId = productSelect.value;
            const qty = Number(qtyInput.value);
            const cost = Number(costInput.value);

            if (!productId || qty <= 0 || cost < 0) {
                showToast('Please select a product and enter valid quantity/cost.');
                return;
            }
            const existingItem = currentPurchase.items.find(item => item.productId === productId);
            if (existingItem) {
                existingItem.qty = Number(existingItem.qty) + qty;
                existingItem.cost = cost;
            } else {
                currentPurchase.items.push({ id: uid(), productId, qty, cost });
            }
            renderItems();
            productSelect.value = '';
            qtyInput.value = 1;
            costInput.value = '';
        };

        window.removePurchaseItem = (itemId) => {
            currentPurchase.items = currentPurchase.items.filter(item => item.id !== itemId);
            renderItems();
        };

        savePurchaseBtn.onclick = () => {
            const form = document.getElementById('purchase-form');
            const formData = new FormData(form);
            const bill = formData.get('bill');
            const date = formData.get('date');
            const supplierId = formData.get('supplierId');
            const paid = Number(paidInput.value);

            if (!bill || !date || !supplierId || currentPurchase.items.length === 0) {
                showToast('Please fill out all fields and add at least one item.');
                return;
            }

            const allPurchases = load('purchases');
            const allProducts = load('products');
            const updatedProducts = [...allProducts];

            currentPurchase.bill = bill;
            currentPurchase.date = date;
            currentPurchase.supplierId = supplierId;
            currentPurchase.paid = paid;

            if (purchaseId) { // Edit existing purchase
                const originalPurchase = allPurchases.find(p => p.id === purchaseId);
                const purchaseItemsDiff = getItemsDiff(originalPurchase.items, currentPurchase.items);

                purchaseItemsDiff.added.forEach(item => {
                    const product = updatedProducts.find(p => p.id === item.productId);
                    if (product) product.stock = Number(product.stock) + Number(item.qty);
                });
                purchaseItemsDiff.removed.forEach(item => {
                    const product = updatedProducts.find(p => p.id === item.productId);
                    if (product) product.stock = Number(product.stock) - Number(item.qty);
                });
                purchaseItemsDiff.updated.forEach(item => {
                    const product = updatedProducts.find(p => p.id === item.productId);
                    if (product) product.stock = Number(product.stock) - Number(item.oldQty) + Number(item.newQty);
                });

                save('purchases', allPurchases.map(p => p.id === purchaseId ? currentPurchase : p));
            } else { // New purchase
                currentPurchase.id = uid('p');
                allPurchases.unshift(currentPurchase);
                save('purchases', allPurchases);

                currentPurchase.items.forEach(item => {
                    const product = updatedProducts.find(p => p.id === item.productId);
                    if (product) product.stock = Number(product.stock) + Number(item.qty);
                });
            }

            save('products', updatedProducts);
            showToast('Bill saved successfully.');
            render('purchases');
        };
    }

    // ========== RENDER: PAYMENTS & RECEIPTS ==========
    function renderPayments({ payments, sales, purchases, customers, suppliers }) {
        main.innerHTML = `
            <h2>Payments & Receipts</h2>
            <div class="card">
                <h3>Record Payment/Receipt</h3>
                <form id="payment-form">
                    <input type="hidden" name="id">
                    <div class="row">
                        <div style="flex:1"><label>Date</label><input type="date" name="date" value="${today()}" required></div>
                        <div style="flex:2"><label>Type</label><select name="type" required>
                            <option value="">Select Type</option>
                            <option value="receipt">Receipt (from Customer)</option>
                            <option value="payment">Payment (to Supplier)</option>
                        </select></div>
                        <div style="flex:3"><label>Contact</label><select name="contactId" id="contact-select" required><option value="">Select a Contact</option></select></div>
                        <div style="flex:2"><label>Amount (‚Çπ)</label><input type="number" name="amount" min="0" step="0.01" required></div>
                    </div>
                    <div class="row" style="justify-content:flex-end; margin-top:16px;">
                        <button type="submit" class="btn primary">Save Transaction</button>
                    </div>
                </form>
            </div>
            <div class="card">
                <h3>All Transactions</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Contact</th>
                            <th class="right">Amount (‚Çπ)</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${payments.map(p => {
                            const contactName = (customers.find(c => c.id === p.contactId)?.name || suppliers.find(s => s.id === p.contactId)?.name) || 'N/A';
                            return `<tr>
                                <td>${p.date}</td>
                                <td>${p.type}</td>
                                <td>${contactName}</td>
                                <td class="right">‚Çπ ${fmt(p.amount)}</td>
                                <td><button class="btn danger small" onclick="deleteItem('payments', '${p.id}')">Del</button></td>
                            </tr>`;
                        }).join('')}
                    </tbody>
                </table>
            </div>`;

        const form = document.getElementById('payment-form');
        const typeSelect = form.querySelector('select[name="type"]');
        const contactSelect = document.getElementById('contact-select');

        const updateContactOptions = () => {
            const type = typeSelect.value;
            let options = '<option value="">Select a Contact</option>';
            if (type === 'receipt') {
                options += customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            } else if (type === 'payment') {
                options += suppliers.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            }
            contactSelect.innerHTML = options;
        };

        typeSelect.onchange = updateContactOptions;
        updateContactOptions();

        form.onsubmit = (e) => {
            e.preventDefault();
            const payment = Object.fromEntries(new FormData(form));
            const allPayments = load('payments');
            payment.id = uid('t');
            allPayments.unshift(payment);
            save('payments', allPayments);
            showToast('Transaction saved.');
            render('payments');
        };
    }

    // ========== RENDER: REPORTS & EXPORT ==========
    function renderReports({ sales, purchases, payments }) {
        main.innerHTML = `
            <h2>Reports & Export</h2>
            <div class="card">
                <h3>Export Data</h3>
                <p>Export all your data as a JSON file. This is useful for backups or transferring data to another device.</p>
                <button class="btn primary" id="export-btn">Export All Data</button>
            </div>
            <div class="card">
                <h3>Import Data</h3>
                <p>Import a previously exported JSON file. <strong>Warning:</strong> This will permanently overwrite all existing data.</p>
                <div class="row">
                    <div style="flex:1;"><input type="file" id="import-file" accept="application/json"></div>
                    <div style="margin-top:21px;"><button class="btn danger" id="import-btn">Import Data</button></div>
                </div>
            </div>`;

        document.getElementById('export-btn').onclick = () => {
            const data = LS_KEYS.reduce((acc, k) => ({ ...acc, [k]: load(k) }), {});
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sales_purchase_data_${today()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('Data exported successfully!');
        };

        document.getElementById('import-btn').onclick = () => {
            const fileInput = document.getElementById('import-file');
            if (fileInput.files.length === 0) {
                showToast('Please select a file to import.');
                return;
            }
            if (!confirm('ARE YOU SURE?\nThis will permanently delete all current data and replace it with the data from the file.')) {
                return;
            }

            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const data = JSON.parse(e.target.result);
                    let imported = 0;
                    for (const key of LS_KEYS) {
                        if (data[key] && Array.isArray(data[key])) {
                            save(key, data[key]);
                            imported++;
                        }
                    }
                    if (imported > 0) {
                        showToast('Data successfully imported! The app will now reload.');
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        showToast('Import failed: Invalid file format.');
                    }
                } catch (err) {
                    showToast('Import failed: Could not parse the file.');
                }
            };
            reader.readAsText(fileInput.files[0]);
        };
    }

    // ========== RENDER: OTHER REPORTS ==========
    function renderLedgerSelection({ customers, suppliers }) {
        main.innerHTML = `
            <h2>Ledger Reports</h2>
            <div class="card">
                <p>Select a customer or supplier to view their ledger.</p>
                <div class="row">
                    <div style="flex:1"><label>Select Contact</label><select id="contact-select">
                        <option value="">Select a contact</option>
                        <optgroup label="Customers">
                            ${customers.map(c => `<option value="customer-${c.id}">${c.name}</option>`).join('')}
                        </optgroup>
                        <optgroup label="Suppliers">
                            ${suppliers.map(s => `<option value="supplier-${s.id}">${s.name}</option>`).join('')}
                        </optgroup>
                    </select></div>
                    <div style="margin-top:21px;"><button class="btn primary" id="view-ledger-btn">View Ledger</button></div>
                </div>
            </div>
            <div id="ledger-content"></div>`;

        document.getElementById('view-ledger-btn').onclick = () => {
            const selected = document.getElementById('contact-select').value;
            if (selected) {
                const [type, id] = selected.split('-');
                render('contact_ledger', { type, id });
            } else {
                showToast('Please select a contact.');
            }
        };
    }

    function renderContactLedger({ sales, purchases, payments, customers, suppliers }, { type, id }) {
        const contact = (type === 'customer' ? customers : suppliers).find(c => c.id === id);
        if (!contact) {
            main.innerHTML = '<div class="card">Contact not found.</div>';
            return;
        }

        const transactions = [
            ...(type === 'customer' ? sales.filter(s => s.customerId === id).map(s => ({ ...s, type: 'Sale', amount: s.total, paid: s.paid })) : []),
            ...(type === 'supplier' ? purchases.filter(p => p.supplierId === id).map(p => ({ ...p, type: 'Purchase', amount: p.total, paid: p.paid })) : []),
            ...payments.filter(p => p.contactId === id).map(p => ({ ...p, type: p.type === 'receipt' ? 'Receipt' : 'Payment', amount: p.amount, paid: p.amount })),
        ].sort((a, b) => new Date(a.date) - new Date(b.date));

        let balance = 0;
        const rows = transactions.map(t => {
            const debit = (t.type === 'Sale' || t.type === 'Payment') ? t.amount : 0;
            const credit = (t.type === 'Receipt' || t.type === 'Purchase') ? t.amount : 0;
            balance += (t.type === 'Sale' || t.type === 'Payment' || t.type === 'Purchase') ? (debit - t.paid) - credit : credit - debit;
            return `<tr>
                <td>${t.date}</td>
                <td>${t.type}</td>
                <td>${t.invoice || t.bill || 'N/A'}</td>
                <td class="right">${fmt(debit)}</td>
                <td class="right">${fmt(credit)}</td>
                <td class="right">${fmt(balance)}</td>
            </tr>`;
        }).join('');

        main.innerHTML = `
            <h2>Ledger for ${contact.name}</h2>
            <div class="card">
                <h3>Balance: ‚Çπ ${fmt(balance)}</h3>
            </div>
            <div class="card">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Ref #</th>
                            <th class="right">Debit (‚Çπ)</th>
                            <th class="right">Credit (‚Çπ)</th>
                            <th class="right">Balance (‚Çπ)</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            </div>`;
    }

    function renderReceivables({ sales, customers }) {
        const receivables = sales.filter(s => (s.total || 0) > (s.paid || 0)).map(s => ({
            ...s,
            customerName: customers.find(c => c.id === s.customerId)?.name || 'N/A',
            due: (s.total || 0) - (s.paid || 0)
        }));

        main.innerHTML = `
            <h2>Receivables</h2>
            <div class="card">
                <h3>Total Amount Due: ‚Çπ ${fmt(receivables.reduce((sum, s) => sum + s.due, 0))}</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Invoice #</th>
                            <th>Customer</th>
                            <th class="right">Total</th>
                            <th class="right">Paid</th>
                            <th class="right">Due</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${receivables.map(r => `
                            <tr>
                                <td>${r.date}</td>
                                <td>${r.invoice}</td>
                                <td>${r.customerName}</td>
                                <td class="right">‚Çπ ${fmt(r.total)}</td>
                                <td class="right">‚Çπ ${fmt(r.paid)}</td>
                                <td class="right" style="color:#ef4444">‚Çπ ${fmt(r.due)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>`;
    }

    function renderPayables({ purchases, suppliers }) {
        const payables = purchases.filter(p => (p.total || 0) > (p.paid || 0)).map(p => ({
            ...p,
            supplierName: suppliers.find(s => s.id === p.supplierId)?.name || 'N/A',
            due: (p.total || 0) - (p.paid || 0)
        }));

        main.innerHTML = `
            <h2>Payables</h2>
            <div class="card">
                <h3>Total Amount Due: ‚Çπ ${fmt(payables.reduce((sum, p) => sum + p.due, 0))}</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Bill #</th>
                            <th>Supplier</th>
                            <th class="right">Total</th>
                            <th class="right">Paid</th>
                            <th class="right">Due</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${payables.map(p => `
                            <tr>
                                <td>${p.date}</td>
                                <td>${p.bill}</td>
                                <td>${p.supplierName}</td>
                                <td class="right">‚Çπ ${fmt(p.total)}</td>
                                <td class="right">‚Çπ ${fmt(p.paid)}</td>
                                <td class="right" style="color:#ef4444">‚Çπ ${fmt(p.due)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>`;
    }

    // ========== APP INITIALIZATION =========
    (function init() {
        if (localStorage.getItem('theme') === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
        }
        initIfEmpty();
        render('dashboard');
    })();
  </script>
</body>
</html>
