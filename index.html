<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Sales & Purchase ‚Äî Updated</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --accent: #6b46c1; /* Deeper purple */
      --muted: #6b7280;
      --border: #e5e7eb;
      --bg: #f9fafb;
      --card-bg: #ffffff;
      --text: #111827;
      --shadow: rgba(15, 23, 42, 0.06);
      --sales: #10b981; /* Emerald */
      --purchases: #3b82f6; /* Blue */
      --profit: #f59e0b; /* Amber */
      --receivables: #ef4444; /* Red */
      --payables: #6b7280; /* Gray */
    }
    [data-theme="dark"] {
      --accent: #a78bfa; /* Lighter purple */
      --muted: #9ca3af;
      --border: #374151;
      --bg: #111827;
      --card-bg: #1f2937;
      --text: #f3f4f6;
      --shadow: rgba(0, 0, 0, 0.2);
      --sales: #10b981;
      --purchases: #3b82f6;
      --profit: #f59e0b;
      --receivables: #ef4444;
      --payables: #9ca3af;
    }
    body {
        font-family: 'Inter', system-ui, sans-serif;
        margin: 0;
        background: var(--bg);
        color: var(--text);
        transition: background 0.3s ease;
        line-height: 1.6;
    }
    header {
        background: var(--accent);
        color: white;
        padding: 14px 18px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        position: sticky;
        top: 0;
        z-index: 10;
    }
    header h1 {
        font-size: 18px;
        font-weight: 600;
        margin: 0;
    }
    .wrap {
        display: flex;
        gap: 16px;
        padding: 16px;
        align-items: flex-start;
    }
    nav {
        width: 260px;
        background: var(--card-bg);
        padding: 12px;
        border-radius: 12px;
        box-shadow: 0 6px 18px var(--shadow);
        position: sticky;
        top: 60px;
    }
    nav button {
        display: flex;
        gap: 10px;
        align-items: center;
        width: 100%;
        padding: 10px 12px;
        border-radius: 8px;
        border: none;
        background: transparent;
        cursor: pointer;
        color: var(--text);
        font-size: 14px;
        text-align: left;
        transition: all 0.2s;
    }
    nav button:hover {
        background: rgba(107, 70, 193, 0.08);
    }
    nav button.active {
        background: linear-gradient(90deg, rgba(107,70,193,.1), rgba(107,70,193,.05));
        font-weight: 600;
        color: var(--accent);
    }
    main {
        flex: 1;
        background: var(--card-bg);
        padding: 16px;
        border-radius: 12px;
        box-shadow: 0 6px 18px var(--shadow);
    }
    h2 {
        margin: 0 0 16px 0;
        font-size: 20px;
        font-weight: 600;
    }
    h3 {
        font-size: 16px;
        font-weight: 600;
        margin-top: 0;
    }
    .row {
        display: flex;
        gap: 12px;
        margin-bottom: 8px;
        flex-wrap: wrap;
    }
    label {
        display: block;
        font-size: 13px;
        font-weight: 500;
        margin-bottom: 4px;
    }
    input, select, textarea, button {
        font-family: inherit;
        font-size: 14px;
    }
    input, select, textarea {
        padding: 10px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: var(--bg);
        color: var(--text);
        width: 100%;
        box-sizing: border-box;
    }
    input:focus, select:focus, textarea:focus {
        outline: 2px solid var(--accent);
        border-color: var(--accent);
    }
    button.btn {
        padding: 10px 14px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-weight: 500;
        transition: background 0.2s ease, transform 0.2s ease;
    }
    button.btn:hover {
        transform: translateY(-1px);
    }
    button.primary { background: var(--accent); color: white; }
    button.ghost { background: transparent; border: 1px solid var(--border); color: var(--text); }
    button.danger { background: #ef4444; color: white; }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 16px;
    }
    th, td {
        padding: 10px;
        border-bottom: 1px solid var(--border);
        text-align: left;
        font-size: 14px;
    }
    th {
        background: var(--bg);
        font-weight: 600;
    }
    .right { text-align: right; }
    .center { text-align: center; }
    .small { font-size: 12px; color: var(--muted); }
    .bold { font-weight: 600; }
    .card {
        background: var(--card-bg);
        padding: 16px;
        border-radius: 10px;
        box-shadow: 0 4px 12px var(--shadow);
        margin-bottom: 16px;
    }
    .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 16px;
        border-radius: 8px;
        background: #333;
        color: white;
        z-index: 100;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        opacity: 0;
        transform: translateY(-10px);
        transition: all 0.3s ease;
    }
    .toast.show {
        opacity: 1;
        transform: translateY(0);
    }
    footer {
        padding: 16px;
        text-align: center;
        color: var(--muted);
        font-size: 13px;
    }
    .theme-toggle {
        background: rgba(255,255,255,0.2);
        border: 1px solid rgba(255,255,255,0.3);
        color: white;
        padding: 6px 10px;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.2s ease;
    }
    .theme-toggle:hover {
        background: rgba(255,255,255,0.3);
    }
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 16px;
    }
    .dashboard-card {
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        color: white;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }
    .dashboard-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 6px 16px rgba(0,0,0,0.1);
    }
    .dashboard-card::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.1);
        transition: background 0.3s ease;
        pointer-events: none;
    }
    .dashboard-card:hover::after {
        background: rgba(0, 0, 0, 0);
    }
    .dashboard-card h3 {
        margin: 0;
        font-size: 14px;
        font-weight: 500;
        opacity: 0.8;
    }
    .dashboard-card .value {
        font-size: 28px;
        font-weight: 700;
        margin-top: 8px;
    }
    .dashboard-sales { background: linear-gradient(135deg, #10b981, #059669); }
    .dashboard-purchases { background: linear-gradient(135deg, #3b82f6, #2563eb); }
    .dashboard-profit { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .dashboard-receivables { background: linear-gradient(135deg, #ef4444, #dc2626); }
    .dashboard-payables { background: linear-gradient(135deg, #6b7280, #4b5563); }

    .clickable { cursor: pointer; }

    /* Auto-complete dropdown styling */
    .autocomplete {
      position: relative;
    }
    .autocomplete-list {
      position: absolute;
      z-index: 1;
      width: 100%;
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid var(--border);
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 4px 12px var(--shadow);
    }
    .autocomplete-list-item {
      padding: 10px;
      cursor: pointer;
      font-size: 14px;
    }
    .autocomplete-list-item:hover {
      background: rgba(107, 70, 193, 0.08);
    }

    @media (max-width: 880px) {
        .wrap {
            flex-direction: column;
            padding: 8px;
        }
        nav {
            width: 100%;
            position: relative;
            top: 0;
            margin-bottom: 16px;
        }
        main {
            width: 100%;
            padding: 12px;
        }
        header h1 {
            font-size: 16px;
        }
        .dashboard-grid {
            grid-template-columns: 1fr;
        }
        .row {
            flex-direction: column;
        }
        .row > div {
            width: 100%;
        }
        table {
            font-size: 12px;
        }
        th, td {
            padding: 8px 6px;
        }
    }

    @media print {
        body * { visibility: hidden; }
        #printable-area, #printable-area * { visibility: visible; }
        #printable-area { position: absolute; left: 0; top: 0; width: 100%; }
        .no-print { display: none; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Sales & Purchase Management</h1>
    <button class="theme-toggle" onclick="toggleTheme()">üåô / ‚òÄÔ∏è</button>
  </header>

  <div class="wrap">
    <nav id="nav" class="no-print">
      <button data-tab="dashboard" class="active">Dashboard</button>
      <button data-tab="products">Products & Stock</button>
      <button data-tab="customers">Customers</button>
      <button data-tab="suppliers">Suppliers</button>
      <button data-tab="sales">Sales Invoices</button>
      <button data-tab="purchases">Purchase Bills</button>
      <button data-tab="payments">Payments & Receipts</button>
      <button data-tab="reports">Reports & Export</button>
    </nav>
    <main id="main"></main>
  </div>

  <footer class="no-print">Fully offline. Data saved in browser. Export/Import JSON in Reports.</footer>
  <div id="toast" class="toast no-print"></div>
  <div id="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:200; align-items:center; justify-content:center;">
    <div style="background:var(--card-bg); padding:24px; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,0.2); max-width:400px; width:90%;">
      <p id="modal-text" style="font-size:16px; margin-bottom:24px;"></p>
      <div style="display:flex; justify-content:flex-end; gap:12px;">
        <button id="modal-cancel" class="btn ghost">Cancel</button>
        <button id="modal-confirm" class="btn danger">Confirm</button>
      </div>
    </div>
  </div>

  <script>
    const main = document.getElementById('main');
    const nav = document.getElementById('nav');

    // ========== UTILS & CORE ==========
    const uid = (p = 'id') => p + Date.now().toString(36) + Math.random().toString(36).slice(2, 6);
    const fmt = n => Number(n || 0).toLocaleString('en-IN', { maximumFractionDigits: 2, minimumFractionDigits: 2 });
    const today = () => new Date().toISOString().slice(0, 10);
    const LS_KEYS = ['products', 'customers', 'suppliers', 'sales', 'purchases', 'payments'];

    function load(key) { try { return JSON.parse(localStorage.getItem(key) || '[]'); } catch { return []; } }
    function save(key, arr) { localStorage.setItem(key, JSON.stringify(arr || [])); }
    function showToast(msg) {
        const toast = document.getElementById('toast');
        toast.textContent = msg;
        toast.className = 'toast show';
        setTimeout(() => { toast.className = 'toast'; }, 3000);
    }
    function toggleTheme() {
        const root = document.documentElement;
        const isDark = root.getAttribute('data-theme') === 'dark';
        root.setAttribute('data-theme', isDark ? 'light' : 'dark');
        localStorage.setItem('theme', isDark ? 'light' : 'dark');
    }

    function showModal(message) {
        return new Promise((resolve) => {
            const modal = document.getElementById('modal');
            const modalText = document.getElementById('modal-text');
            const modalConfirm = document.getElementById('modal-confirm');
            const modalCancel = document.getElementById('modal-cancel');

            modalText.textContent = message;
            modal.style.display = 'flex';

            const handleConfirm = () => {
                modal.style.display = 'none';
                modalConfirm.removeEventListener('click', handleConfirm);
                modalCancel.removeEventListener('click', handleCancel);
                resolve(true);
            };

            const handleCancel = () => {
                modal.style.display = 'none';
                modalConfirm.removeEventListener('click', handleConfirm);
                modalCancel.removeEventListener('click', handleCancel);
                resolve(false);
            };

            modalConfirm.addEventListener('click', handleConfirm);
            modalCancel.addEventListener('click', handleCancel);
        });
    }

    // New helper function to calculate profit for a single transaction (sale or purchase)
    function calculateProfit(items, products) {
        return items.reduce((totalProfit, item) => {
            const product = products.find(p => p.id === item.productId);
            if (!product) return totalProfit;
            const itemCost = product.cost || 0;
            const itemPrice = item.price || 0;
            const profitPerItem = itemPrice - itemCost;
            return totalProfit + (profitPerItem * (item.qty || 0));
        }, 0);
    }

    // ========== INITIAL DATA SETUP ==========
    function initIfEmpty() {
        if (!load('products').length) save('products', [
            { id: uid('p'), sku: 'P-001', name: 'Widget A', category: 'General', price: 100, cost: 70, stock: 50, unit: 'pcs', minStock: 5 },
            { id: uid('p'), sku: 'P-002', name: 'Widget B', category: 'General', price: 200, cost: 140, stock: 30, unit: 'pcs', minStock: 5 }
        ]);
        if (!load('customers').length) save('customers', [{ id: uid('c'), name: 'Walk-in Customer', phone: '', email: '' }]);
        LS_KEYS.forEach(k => { if (!localStorage.getItem(k)) save(k, []); });
    }

    // ========== NAVIGATION & ROUTING ==========
    nav.addEventListener('click', e => {
        const btn = e.target.closest('button[data-tab]');
        if (!btn) return;
        nav.querySelectorAll('button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        render(btn.dataset.tab);
    });

    function render(tab, id) {
        const data = LS_KEYS.reduce((acc, k) => ({ ...acc, [k]: load(k) }), {});
        const renderer = {
            dashboard: renderDashboard,
            products: renderProducts,
            customers: renderCustomers,
            suppliers: renderSuppliers,
            sales: renderSales,
            new_sale: renderSaleForm,
            purchases: renderPurchases,
            new_purchase: renderPurchaseForm,
            payments: renderPayments,
            reports: renderReports,
            receivables: renderReceivables,
            payables: renderPayables,
        }[tab];
        if (renderer) renderer(data, id);
    }
    window.redirect = render;

    // ========== RENDER: DASHBOARD ==========
    function renderDashboard({ products, sales, purchases, customers, suppliers }) {
      const fromDate = document.getElementById('from-date')?.value || today();
      const toDate = document.getElementById('to-date')?.value || today();

      const filteredSales = sales.filter(s => s.date >= fromDate && s.date <= toDate);
      const filteredPurchases = purchases.filter(p => p.date >= fromDate && p.date <= toDate);

      const totalSales = filteredSales.reduce((s,x) => s + Number(x.total||0), 0);
      const totalPurchases = filteredPurchases.reduce((s,x) => s + Number(x.total||0), 0);
      const profit = filteredSales.reduce((s, x) => s + calculateProfit(x.items, products), 0);

      const receivables = sales.reduce((s,x) => s + (Number(x.total||0) - Number(x.paid||0)), 0);
      const payables = purchases.reduce((s,x) => s + (Number(x.total||0) - Number(x.paid||0)), 0);
      const lowStock = products.filter(p => Number(p.stock||0) <= Number(p.minStock||0));

      main.innerHTML = `
        <h2>Dashboard</h2>
        <div class="card">
            <h3 style="margin-top:0">Date Range</h3>
            <div class="row">
                <div style="flex:1"><label>From</label><input type="date" id="from-date" value="${fromDate}"></div>
                <div style="flex:1"><label>To</label><input type="date" id="to-date" value="${toDate}"></div>
                <div style="margin-top:21px;"><button class="btn primary" id="filter-btn">Apply Filter</button></div>
            </div>
        </div>
        <div class="dashboard-grid">
            <div class="dashboard-card dashboard-sales clickable" onclick="redirect('sales')">
                <h3>Total Sales</h3>
                <div class="value">‚Çπ ${fmt(totalSales)}</div>
            </div>
            <div class="dashboard-card dashboard-purchases clickable" onclick="redirect('purchases')">
                <h3>Total Purchases</h3>
                <div class="value">‚Çπ ${fmt(totalPurchases)}</div>
            </div>
            <div class="dashboard-card dashboard-profit">
                <h3>Profit</h3>
                <div class="value">‚Çπ ${fmt(profit)}</div>
            </div>
            <div class="dashboard-card dashboard-receivables clickable" onclick="redirect('receivables')">
                <h3>Receivables</h3>
                <div class="value">‚Çπ ${fmt(receivables)}</div>
            </div>
            <div class="dashboard-card dashboard-payables clickable" onclick="redirect('payables')">
                <h3>Payables</h3>
                <div class="value">‚Çπ ${fmt(payables)}</div>
            </div>
        </div>
        <div class="card">
          <h3 style="margin-top:0">Low Stock Alerts</h3>
          ${lowStock.length ? `<table><thead><tr><th>SKU</th><th>Product</th><th class="right">Stock</th><th class="right">Min Stock</th></tr></thead><tbody>${lowStock.map(p => `
                <tr><td>${p.sku}</td><td>${p.name}</td><td class="right">${p.stock} ${p.unit}</td><td class="right">${p.minStock}</td></tr>`).join('')}</tbody></table>`
                 : '<div class="small">No low stock items</div>'}
        </div>`;

        document.getElementById('filter-btn').onclick = () => render('dashboard');
    }

    // ========== RENDER: GENERIC CRUD (FOR PRODUCTS, CUSTOMERS, SUPPLIERS) ==========
    function renderCRUD(opts) {
        const items = load(opts.key);
        main.innerHTML = `
            <h2>${opts.title}</h2>
            <div class="card">
                <form id="crud-form">
                    <input type="hidden" name="id">
                    <div class="row">${opts.fields.map(f => `<div style="flex:${f.flex||1}"><label>${f.label}</label><input name="${f.name}" type="${f.type||'text'}" placeholder="${f.placeholder||''}"></div>`).join('')}</div>
                    <div class="row" style="justify-content:flex-end; margin-top:16px;">
                      <button type="button" class="btn ghost" onclick="this.closest('form').reset()">Clear</button>
                      <button type="submit" class="btn primary">Save ${opts.singular}</button>
                    </div>
                </form>
            </div>
            <div class="card">
                <h3>All ${opts.title}</h3>
                <table>
                    <thead><tr>${opts.headers.map(h => `<th>${h}</th>`).join('')}<th>Actions</th></tr></thead>
                    <tbody>${items.map(it => `<tr>${opts.row(it).map(td => `<td>${td}</td>`).join('')}
                        <td><button class="btn ghost small" onclick="editItem('${opts.key}', '${it.id}')">Edit</button> <button class="btn danger small" onclick="deleteItem('${opts.key}', '${it.id}')">Del</button></td>
                    </tr>`).join('')}</tbody>
                </table>
            </div>`;

        document.getElementById('crud-form').onsubmit = e => {
            e.preventDefault();
            const form = e.target;
            const item = Object.fromEntries(new FormData(form));
            const allItems = load(opts.key);
            if (item.id) {
                save(opts.key, allItems.map(i => i.id === item.id ? { ...i, ...item } : i));
            } else {
                item.id = uid(opts.key[0]);
                allItems.unshift(item);
                save(opts.key, allItems);
            }
            showToast(`${opts.singular} saved.`);
            render(opts.key);
        };
    }

    window.editItem = (key, id) => {
        const item = load(key).find(i => i.id === id);
        if (!item) return;
        const form = document.getElementById('crud-form');
        for (const prop in item) {
            if (form.elements[prop]) {
                form.elements[prop].value = item[prop];
            }
        }
        window.scrollTo(0, 0);
    }

    window.deleteItem = async (key, id) => {
        if (await showModal('Are you sure you want to delete this item?')) {
            save(key, load(key).filter(i => i.id !== id));
            showToast('Item deleted.');
            render(key);
        }
    }
    
    // ========== RENDER: PRODUCTS, CUSTOMERS, SUPPLIERS (USING GENERIC CRUD) ==========
    function renderProducts() {
        renderCRUD({
            key: 'products',
            title: 'Products & Stock',
            singular: 'Product',
            fields: [
                { name: 'sku', label: 'SKU', flex: 1 },
                { name: 'name', label: 'Product Name', flex: 2 },
                { name: 'price', label: 'Sale Price (‚Çπ)', type: 'number', flex: 1 },
                { name: 'cost', label: 'Cost Price (‚Çπ)', type: 'number', flex: 1 },
                { name: 'stock', label: 'Stock', type: 'number', flex: 1 },
                { name: 'minStock', label: 'Min Stock', type: 'number', flex: 1 },
                { name: 'unit', label: 'Unit (pcs, kg)', flex: 1 },
            ],
            headers: ['SKU', 'Name', 'Sale Price', 'Cost', 'Stock'],
            row: p => [p.sku, p.name, `‚Çπ ${fmt(p.price)}`, `‚Çπ ${fmt(p.cost)}`, `${p.stock||0} ${p.unit||''}`]
        });
    }

    function renderCustomers() {
        renderCRUD({
            key: 'customers',
            title: 'Customers',
            singular: 'Customer',
            fields: [
                { name: 'name', label: 'Name', flex: 2 },
                { name: 'phone', label: 'Phone', flex: 1 },
                { name: 'email', label: 'Email', flex: 1 }
            ],
            headers: ['Name', 'Phone', 'Email'],
            row: c => [c.name, c.phone, c.email]
        });
    }

    function renderSuppliers() {
        renderCRUD({
            key: 'suppliers',
            title: 'Suppliers',
            singular: 'Supplier',
            fields: [
                { name: 'name', label: 'Name', flex: 2 },
                { name: 'phone', label: 'Phone', flex: 1 },
                { name: 'email', label: 'Email', flex: 1 }
            ],
            headers: ['Name', 'Phone', 'Email'],
            row: s => [s.name, s.phone, s.email]
        });
    }

    // ========== RENDER: SALES LIST ==========
    function renderSales({ sales, customers, products }) {
        main.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                <h2>Sales Invoices</h2>
                <button class="btn primary no-print" onclick="render('new_sale')">New Invoice</button>
            </div>
            <div class="card">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Invoice #</th>
                            <th>Customer</th>
                            <th class="right">Total</th>
                            <th class="right">Profit</th>
                            <th class="right">Due</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sales.map(s => {
                            const cust = customers.find(c => c.id === s.customerId)?.name || 'N/A';
                            const due = (s.total || 0) - (s.paid || 0);
                            const profit = calculateProfit(s.items, products);
                            return `<tr class="clickable" onclick="render('new_sale', '${s.id}')">
                                <td>${s.date}</td>
                                <td>${s.invoice}</td>
                                <td>${cust}</td>
                                <td class="right">‚Çπ ${fmt(s.total)}</td>
                                <td class="right">‚Çπ ${fmt(profit)}</td>
                                <td class="right" style="color:${due > 0 ? '#ef4444' : 'inherit'}">‚Çπ ${fmt(due)}</td>
                            </tr>`;
                        }).join('')}
                    </tbody>
                </table>
            </div>`;
    }

    // ========== RENDER: NEW/EDIT SALE FORM ==========
    function renderSaleForm({ products, customers }, saleId) {
        let sale = load('sales').find(s => s.id === saleId) || { id: uid('s'), date: today(), items: [], paid: 0 };

        main.innerHTML = `
            <h2>${saleId ? 'Edit Sales Invoice' : 'New Sales Invoice'}</h2>
            <div class="card">
                <form id="sale-form">
                    <input type="hidden" name="id" value="${sale.id}">
                    <div class="row">
                        <div style="flex:1"><label>Invoice #</label><input type="text" name="invoice" id="invoice-input" value="${sale.invoice || ''}" placeholder="Leave empty for auto-generation"></div>
                        <div style="flex:1"><label>Date</label><input type="date" name="date" value="${sale.date}"></div>
                    </div>
                    <div class="row">
                        <div style="flex:2">
                          <label>Customer</label>
                          <select name="customerId">
                            ${customers.map(c => `<option value="${c.id}" ${sale.customerId === c.id ? 'selected' : ''}>${c.name}</option>`).join('')}
                          </select>
                        </div>
                    </div>
                </form>
                <div class="row" style="align-items:flex-end;">
                    <div style="flex:2">
                      <label>Select Product</label>
                      <div class="autocomplete">
                        <input type="text" id="product-search-input" placeholder="Start typing to search products...">
                        <div id="product-autocomplete-list" class="autocomplete-list" style="display:none;"></div>
                      </div>
                    </div>
                    <div style="flex:1"><label>Quantity</label><input type="number" id="item-qty" value="1"></div>
                    <div style="flex:1"><label>Price (‚Çπ)</label><input type="number" id="item-price" value="" step="0.01"></div>
                    <div style="flex:0; margin-top:21px;"><button class="btn primary" id="add-item-btn">Add</button></div>
                </div>

                <div class="card" style="margin-top:24px;">
                    <h3>Items on this Invoice</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th class="right">Qty</th>
                                <th class="right">Price (‚Çπ)</th>
                                <th class="right">Subtotal (‚Çπ)</th>
                                <th class="center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="items-table-body">
                        </tbody>
                    </table>
                </div>

                <div class="row" style="margin-top:24px; justify-content:flex-end; gap:24px;">
                  <div style="flex:1; max-width:200px;">
                    <label>Total Amount</label>
                    <input type="number" id="sale-total-input" disabled>
                  </div>
                  <div style="flex:1; max-width:200px;">
                    <label>Amount Paid</label>
                    <input type="number" id="sale-paid-input" name="paid" value="${sale.paid}">
                  </div>
                </div>
                <div class="row" style="justify-content:flex-end; margin-top:16px;">
                  <button type="button" class="btn ghost" onclick="redirect('sales')">Cancel</button>
                  <button type="submit" class="btn primary" form="sale-form">Save Invoice</button>
                </div>
            </div>`;

        const renderItemsTable = () => {
            const itemsTableBody = document.getElementById('items-table-body');
            itemsTableBody.innerHTML = sale.items.map((item, index) => {
                const product = products.find(p => p.id === item.productId);
                const subtotal = (item.qty || 0) * (item.price || 0);
                return `
                    <tr>
                        <td>${product.name}</td>
                        <td class="right">${item.qty} ${product.unit}</td>
                        <td class="right">‚Çπ ${fmt(item.price)}</td>
                        <td class="right">‚Çπ ${fmt(subtotal)}</td>
                        <td class="center"><button type="button" class="btn danger small" onclick="removeItem(${index})">Del</button></td>
                    </tr>`;
            }).join('');
            const total = sale.items.reduce((sum, item) => sum + ((item.qty || 0) * (item.price || 0)), 0);
            document.getElementById('sale-total-input').value = total.toFixed(2);
            sale.total = total;
        };

        const addItem = () => {
            const productInput = document.getElementById('product-search-input');
            const qtyInput = document.getElementById('item-qty');
            const priceInput = document.getElementById('item-price');
            const selectedProduct = products.find(p => p.name === productInput.value);

            if (!selectedProduct || !qtyInput.value) {
                showToast("Please select a product and enter a quantity.");
                return;
            }

            const item = {
                productId: selectedProduct.id,
                qty: Number(qtyInput.value),
                price: Number(priceInput.value) || selectedProduct.price,
            };

            sale.items.push(item);
            productInput.value = '';
            qtyInput.value = 1;
            priceInput.value = '';
            renderItemsTable();
        };

        window.removeItem = (index) => {
            sale.items.splice(index, 1);
            renderItemsTable();
        };
        
        document.getElementById('add-item-btn').onclick = addItem;
        document.getElementById('sale-paid-input').oninput = e => sale.paid = Number(e.target.value);

        // Auto-complete logic for product search
        const productSearchInput = document.getElementById('product-search-input');
        const productAutocompleteList = document.getElementById('product-autocomplete-list');
        productSearchInput.oninput = () => {
          const query = productSearchInput.value.toLowerCase();
          const filteredProducts = products.filter(p => p.name.toLowerCase().includes(query) || p.sku.toLowerCase().includes(query));
          
          if (query && filteredProducts.length > 0) {
            productAutocompleteList.innerHTML = filteredProducts.map(p => 
              `<div class="autocomplete-list-item" data-product-id="${p.id}">${p.name} (${p.sku})</div>`).join('');
            productAutocompleteList.style.display = 'block';
          } else {
            productAutocompleteList.style.display = 'none';
          }
        };

        productAutocompleteList.onclick = (e) => {
          const item = e.target.closest('.autocomplete-list-item');
          if (item) {
            const productName = item.textContent.split('(')[0].trim();
            const selectedProduct = products.find(p => p.name === productName);
            productSearchInput.value = productName;
            document.getElementById('item-price').value = selectedProduct.price;
            productAutocompleteList.style.display = 'none';
          }
        };

        document.getElementById('sale-form').onsubmit = e => {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const savedSale = load('sales').find(s => s.id === sale.id);
            const allSales = load('sales');

            // Handle auto-generation of invoice number if not manually entered
            if (!formData.get('invoice')) {
                const existingInvoices = allSales.map(s => Number(s.invoice)).filter(n => !isNaN(n));
                const nextInvoiceNum = (existingInvoices.length > 0) ? Math.max(...existingInvoices) + 1 : 1001;
                sale.invoice = nextInvoiceNum.toString();
            } else {
                sale.invoice = formData.get('invoice');
            }

            sale.customerId = formData.get('customerId');
            sale.date = formData.get('date');
            sale.paid = Number(formData.get('paid'));

            if (savedSale) {
                save('sales', allSales.map(s => s.id === sale.id ? sale : s));
            } else {
                allSales.unshift(sale);
                save('sales', allSales);
            }
            showToast('Invoice saved successfully.');
            redirect('sales');
        };

        renderItemsTable();
    }
    
    // ========== RENDER: PURCHASES LIST ==========
    function renderPurchases({ purchases, suppliers, products }) {
        main.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                <h2>Purchase Bills</h2>
                <button class="btn primary no-print" onclick="render('new_purchase')">New Bill</button>
            </div>
            <div class="card">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Bill #</th>
                            <th>Supplier</th>
                            <th class="right">Total</th>
                            <th class="right">Due</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${purchases.map(p => {
                            const supp = suppliers.find(s => s.id === p.supplierId)?.name || 'N/A';
                            const due = (p.total || 0) - (p.paid || 0);
                            return `<tr class="clickable" onclick="render('new_purchase', '${p.id}')">
                                <td>${p.date}</td>
                                <td>${p.bill}</td>
                                <td>${supp}</td>
                                <td class="right">‚Çπ ${fmt(p.total)}</td>
                                <td class="right" style="color:${due > 0 ? '#ef4444' : 'inherit'}">‚Çπ ${fmt(due)}</td>
                            </tr>`;
                        }).join('')}
                    </tbody>
                </table>
            </div>`;
    }

    // ========== RENDER: NEW/EDIT PURCHASE FORM ==========
    function renderPurchaseForm({ products, suppliers }, purchaseId) {
        let purchase = load('purchases').find(p => p.id === purchaseId) || { id: uid('p'), date: today(), items: [], paid: 0 };

        main.innerHTML = `
            <h2>${purchaseId ? 'Edit Purchase Bill' : 'New Purchase Bill'}</h2>
            <div class="card">
                <form id="purchase-form">
                    <input type="hidden" name="id" value="${purchase.id}">
                    <div class="row">
                        <div style="flex:1"><label>Bill #</label><input type="text" name="bill" id="bill-input" value="${purchase.bill || ''}" placeholder="Leave empty for auto-generation"></div>
                        <div style="flex:1"><label>Date</label><input type="date" name="date" value="${purchase.date}"></div>
                    </div>
                    <div class="row">
                        <div style="flex:2">
                            <label>Supplier</label>
                            <select name="supplierId">
                                ${suppliers.map(s => `<option value="${s.id}" ${purchase.supplierId === s.id ? 'selected' : ''}>${s.name}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                </form>
                <div class="row" style="align-items:flex-end;">
                    <div style="flex:2">
                      <label>Select Product</label>
                      <div class="autocomplete">
                        <input type="text" id="purchase-product-search-input" placeholder="Start typing to search products...">
                        <div id="purchase-product-autocomplete-list" class="autocomplete-list" style="display:none;"></div>
                      </div>
                    </div>
                    <div style="flex:1"><label>Quantity</label><input type="number" id="purchase-item-qty" value="1"></div>
                    <div style="flex:1"><label>Cost (‚Çπ)</label><input type="number" id="purchase-item-cost" value="" step="0.01"></div>
                    <div style="flex:0; margin-top:21px;"><button class="btn primary" id="add-purchase-item-btn">Add</button></div>
                </div>

                <div class="card" style="margin-top:24px;">
                    <h3>Items on this Bill</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th class="right">Qty</th>
                                <th class="right">Cost (‚Çπ)</th>
                                <th class="right">Subtotal (‚Çπ)</th>
                                <th class="center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="purchase-items-table-body">
                        </tbody>
                    </table>
                </div>

                <div class="row" style="margin-top:24px; justify-content:flex-end; gap:24px;">
                  <div style="flex:1; max-width:200px;">
                    <label>Total Amount</label>
                    <input type="number" id="purchase-total-input" disabled>
                  </div>
                  <div style="flex:1; max-width:200px;">
                    <label>Amount Paid</label>
                    <input type="number" id="purchase-paid-input" name="paid" value="${purchase.paid}">
                  </div>
                </div>
                <div class="row" style="justify-content:flex-end; margin-top:16px;">
                  <button type="button" class="btn ghost" onclick="redirect('purchases')">Cancel</button>
                  <button type="submit" class="btn primary" form="purchase-form">Save Bill</button>
                </div>
            </div>`;

        const renderPurchaseItemsTable = () => {
            const itemsTableBody = document.getElementById('purchase-items-table-body');
            itemsTableBody.innerHTML = purchase.items.map((item, index) => {
                const product = products.find(p => p.id === item.productId);
                const subtotal = (item.qty || 0) * (item.cost || 0);
                return `
                    <tr>
                        <td>${product.name}</td>
                        <td class="right">${item.qty} ${product.unit}</td>
                        <td class="right">‚Çπ ${fmt(item.cost)}</td>
                        <td class="right">‚Çπ ${fmt(subtotal)}</td>
                        <td class="center"><button type="button" class="btn danger small" onclick="removePurchaseItem(${index})">Del</button></td>
                    </tr>`;
            }).join('');
            const total = purchase.items.reduce((sum, item) => sum + ((item.qty || 0) * (item.cost || 0)), 0);
            document.getElementById('purchase-total-input').value = total.toFixed(2);
            purchase.total = total;
        };

        const addPurchaseItem = () => {
            const productInput = document.getElementById('purchase-product-search-input');
            const qtyInput = document.getElementById('purchase-item-qty');
            const costInput = document.getElementById('purchase-item-cost');
            const selectedProduct = products.find(p => p.name === productInput.value);

            if (!selectedProduct || !qtyInput.value) {
                showToast("Please select a product and enter a quantity.");
                return;
            }

            const item = {
                productId: selectedProduct.id,
                qty: Number(qtyInput.value),
                cost: Number(costInput.value) || selectedProduct.cost,
            };

            purchase.items.push(item);
            productInput.value = '';
            qtyInput.value = 1;
            costInput.value = '';
            renderPurchaseItemsTable();
        };

        window.removePurchaseItem = (index) => {
            purchase.items.splice(index, 1);
            renderPurchaseItemsTable();
        };
        
        document.getElementById('add-purchase-item-btn').onclick = addPurchaseItem;
        document.getElementById('purchase-paid-input').oninput = e => purchase.paid = Number(e.target.value);

        // Auto-complete logic for product search on purchases
        const productSearchInput = document.getElementById('purchase-product-search-input');
        const productAutocompleteList = document.getElementById('purchase-product-autocomplete-list');
        productSearchInput.oninput = () => {
          const query = productSearchInput.value.toLowerCase();
          const filteredProducts = products.filter(p => p.name.toLowerCase().includes(query) || p.sku.toLowerCase().includes(query));
          
          if (query && filteredProducts.length > 0) {
            productAutocompleteList.innerHTML = filteredProducts.map(p => 
              `<div class="autocomplete-list-item" data-product-id="${p.id}">${p.name} (${p.sku})</div>`).join('');
            productAutocompleteList.style.display = 'block';
          } else {
            productAutocompleteList.style.display = 'none';
          }
        };

        productAutocompleteList.onclick = (e) => {
          const item = e.target.closest('.autocomplete-list-item');
          if (item) {
            const productName = item.textContent.split('(')[0].trim();
            const selectedProduct = products.find(p => p.name === productName);
            productSearchInput.value = productName;
            document.getElementById('purchase-item-cost').value = selectedProduct.cost;
            productAutocompleteList.style.display = 'none';
          }
        };

        document.getElementById('purchase-form').onsubmit = e => {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const savedPurchase = load('purchases').find(p => p.id === purchase.id);
            const allPurchases = load('purchases');

            // Handle auto-generation of bill number if not manually entered
            if (!formData.get('bill')) {
                const existingBills = allPurchases.map(p => Number(p.bill)).filter(n => !isNaN(n));
                const nextBillNum = (existingBills.length > 0) ? Math.max(...existingBills) + 1 : 2001;
                purchase.bill = nextBillNum.toString();
            } else {
                purchase.bill = formData.get('bill');
            }

            purchase.supplierId = formData.get('supplierId');
            purchase.date = formData.get('date');
            purchase.paid = Number(formData.get('paid'));

            if (savedPurchase) {
                save('purchases', allPurchases.map(p => p.id === purchase.id ? purchase : p));
            } else {
                allPurchases.unshift(purchase);
                save('purchases', allPurchases);
            }
            showToast('Bill saved successfully.');
            redirect('purchases');
        };

        renderPurchaseItemsTable();
    }
    
    // ========== RENDER: PAYMENTS & RECEIPTS ==========
    function renderPayments({ payments, sales, purchases }) {
      main.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
            <h2>Payments & Receipts</h2>
            <button class="btn primary no-print" onclick="render('new_payment_receipt')">New Entry</button>
        </div>
        <div class="card">
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Contact</th>
                        <th>Bill/Invoice #</th>
                        <th class="right">Amount</th>
                        <th class="center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${payments.map(p => {
                        let contactName = 'N/A';
                        if (p.type === 'receipt') {
                            const sale = sales.find(s => s.id === p.refId);
                            contactName = load('customers').find(c => c.id === sale.customerId)?.name || 'N/A';
                        } else {
                            const purchase = purchases.find(b => b.id === p.refId);
                            contactName = load('suppliers').find(s => s.id === purchase.supplierId)?.name || 'N/A';
                        }
                        const refNum = p.type === 'receipt' ? sales.find(s => s.id === p.refId)?.invoice : purchases.find(b => b.id === p.refId)?.bill;
                        return `<tr>
                            <td>${p.date}</td>
                            <td>${p.type === 'receipt' ? 'Receipt' : 'Payment'}</td>
                            <td>${contactName}</td>
                            <td>${refNum}</td>
                            <td class="right">‚Çπ ${fmt(p.amount)}</td>
                            <td class="center"><button class="btn danger small" onclick="deletePayment('${p.id}')">Del</button></td>
                        </tr>`;
                    }).join('')}
                </tbody>
            </table>
        </div>`;
    }
    
    // ========== RENDER: REPORTS & EXPORT ==========
    function renderReports({ sales, purchases, products, customers, suppliers }) {
        main.innerHTML = `
            <h2>Reports & Export</h2>
            <div class="card">
                <h3>Export/Import Data</h3>
                <div class="row">
                    <button class="btn ghost" onclick="exportData()">Export Data</button>
                    <input type="file" id="import-file" style="display:none;" accept=".json">
                    <button class="btn ghost" onclick="document.getElementById('import-file').click()">Import Data</button>
                </div>
            </div>
            <div class="card">
                <h3>Search Bills & Invoices</h3>
                <div class="row">
                    <div style="flex:1">
                        <label>Search by Bill/Invoice #, Customer, or Supplier</label>
                        <input type="text" id="report-search-input" placeholder="Start typing to search...">
                    </div>
                </div>
                <div id="search-results-table"></div>
            </div>
            <div class="card">
                <h3>Other Reports</h3>
                <div class="row">
                    <button class="btn ghost" onclick="redirect('receivables')">View Receivables</button>
                    <button class="btn ghost" onclick="redirect('payables')">View Payables</button>
                </div>
            </div>`;

        const searchInput = document.getElementById('report-search-input');
        const resultsDiv = document.getElementById('search-results-table');
        
        searchInput.oninput = () => {
            const query = searchInput.value.toLowerCase().trim();
            let results = [];
            
            if (query.length > 1) {
                // Search sales
                sales.forEach(s => {
                    const customer = customers.find(c => c.id === s.customerId);
                    if ((s.invoice && s.invoice.toLowerCase().includes(query)) || (customer && customer.name.toLowerCase().includes(query))) {
                        results.push({
                            type: 'Sales',
                            id: s.id,
                            number: s.invoice,
                            date: s.date,
                            contact: customer?.name || 'N/A',
                            total: s.total,
                            link: `new_sale`
                        });
                    }
                });

                // Search purchases
                purchases.forEach(p => {
                    const supplier = suppliers.find(s => s.id === p.supplierId);
                    if ((p.bill && p.bill.toLowerCase().includes(query)) || (supplier && supplier.name.toLowerCase().includes(query))) {
                        results.push({
                            type: 'Purchases',
                            id: p.id,
                            number: p.bill,
                            date: p.date,
                            contact: supplier?.name || 'N/A',
                            total: p.total,
                            link: `new_purchase`
                        });
                    }
                });
            }
            
            if (results.length > 0) {
                resultsDiv.innerHTML = `
                    <h3>Search Results</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Number</th>
                                <th>Date</th>
                                <th>Contact</th>
                                <th class="right">Total (‚Çπ)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${results.map(r => `
                                <tr class="clickable" onclick="redirect('${r.link}', '${r.id}')">
                                    <td>${r.type}</td>
                                    <td>${r.number}</td>
                                    <td>${r.date}</td>
                                    <td>${r.contact}</td>
                                    <td class="right">‚Çπ ${fmt(r.total)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>`;
            } else if (query.length > 1) {
                resultsDiv.innerHTML = `<div class="small" style="padding: 16px;">No results found.</div>`;
            } else {
                resultsDiv.innerHTML = '';
            }
        };

        window.exportData = () => {
            const data = {};
            LS_KEYS.forEach(key => data[key] = load(key));
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sales_purchase_data_${today()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('Data exported successfully.');
        };

        const importFile = document.getElementById('import-file');
        importFile.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const importedData = JSON.parse(event.target.result);
                    if (await showModal('This will overwrite all existing data. Are you sure?')) {
                        LS_KEYS.forEach(key => {
                            if (importedData[key]) save(key, importedData[key]);
                        });
                        showToast('Data imported successfully.');
                        render('dashboard');
                    }
                } catch (err) {
                    showToast('Failed to import file. Please check the format.');
                    console.error('Import error:', err);
                }
            };
            reader.readAsText(file);
        };
    }

    // ========== RENDER: RECEIVABLES ==========
    function renderReceivables({ sales, customers }) {
        const receivables = sales.filter(s => (s.total || 0) - (s.paid || 0) > 0);
        main.innerHTML = `
            <h2>Receivables (Amount to Receive)</h2>
            <div class="card">
                <h3>Total Amount Due: ‚Çπ ${fmt(receivables.reduce((sum, s) => sum + ((s.total || 0) - (s.paid || 0)), 0))}</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Invoice #</th>
                            <th>Customer</th>
                            <th class="right">Total</th>
                            <th class="right">Paid</th>
                            <th class="right">Due</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${receivables.map(s => `
                            <tr>
                                <td>${s.date}</td>
                                <td>${s.invoice}</td>
                                <td>${customers.find(c => c.id === s.customerId)?.name || 'N/A'}</td>
                                <td class="right">‚Çπ ${fmt(s.total)}</td>
                                <td class="right">‚Çπ ${fmt(s.paid)}</td>
                                <td class="right" style="color:#ef4444">‚Çπ ${fmt((s.total || 0) - (s.paid || 0))}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>`;
    }

    // ========== RENDER: PAYABLES ==========
    function renderPayables({ purchases, suppliers }) {
        const payables = purchases.filter(p => (p.total || 0) - (p.paid || 0) > 0);
        main.innerHTML = `
            <h2>Payables (Amount to Pay)</h2>
            <div class="card">
                <h3>Total Amount Due: ‚Çπ ${fmt(payables.reduce((sum, p) => sum + ((p.total || 0) - (p.paid || 0)), 0))}</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Bill #</th>
                            <th>Supplier</th>
                            <th class="right">Total</th>
                            <th class="right">Paid</th>
                            <th class="right">Due</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${payables.map(p => `
                            <tr>
                                <td>${p.date}</td>
                                <td>${p.bill}</td>
                                <td>${suppliers.find(s => s.id === p.supplierId)?.name || 'N/A'}</td>
                                <td class="right">‚Çπ ${fmt(p.total)}</td>
                                <td class="right">‚Çπ ${fmt(p.paid)}</td>
                                <td class="right" style="color:#ef4444">‚Çπ ${fmt((p.total || 0) - (p.paid || 0))}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>`;
    }

    // ========== APP INITIALIZATION =========
    (function init() {
        if (localStorage.getItem('theme') === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
        }
        initIfEmpty();
        render('dashboard');
    })();
  </script>
</body>
</html>
